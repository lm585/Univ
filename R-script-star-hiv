setwd("/Users/linyongmao/Documents/dir-star-hiv/dir-map-stat")
rawCount <- read.delim("star-hiv-genecount.txt", header = T, row.names = 1)
> dim(rawCount)
[1] 60448    60
> summary(rawCount)
group <- factor(rep(1, 60))
y <- DGEList(counts=rawCount,group=group)
y <- calcNormFactors(y)
d <- cpm(y)
write.table(d, "star-CPM.txt", sep="\t")
plotMDS(y)

 mds1 = plotMDS(y, top = 91234)
 write.table(mds1$x, file = "MDS.op.txt", quote = FALSE, sep = "\t")
 write.table(mds1$y, file = "MDS.op.txt", append = TRUE, quote = FALSE, sep = "\t")
 cmdscale(mds1$distance.matrix , k =2, eig = TRUE)
 r <-  cmdscale(mds1$distance.matrix , k =2, eig = TRUE)
 plot(cumsum(r$eig) / sum(r$eig), 
       type="h", lwd=5, las=1, 
       xlab="Number of dimensions", 
       ylab=expression(R^2))
 (r$eig) / sum(r$eig) ### proportion of variance

 mds2 = plotMDS(y)
 write.table(mds2$x , file = "MDS2.op.txt", quote = FALSE, sep = "\t")
 write.table(mds2$y , file = "MDS2.op.txt", append = TRUE, quote = FALSE, sep = "\t")
 cmdscale(mds2$distance.matrix , k =2, eig = TRUE)

### gene count table for two conditions
cat ../star-HIV-samp-info-two28.txt | grep -w "CD4+ RA.RO" | cut -f 1 > sampID-RA.RO
cat ../star-HIV-samp-info-two28.txt | grep -w "RA-Tscm" | cut -f 1 > sampID-RA-Tscm
bash -x script-sel-colum-with-samp-ids sampID-RA.RO sampID-RA-Tscm
mv -i out gene-count-RARO-RA-Tscm.5-4.txt
x <- read.delim("gene-count-RARO-RA-Tscm.5-4.txt", header = T, row.names=1)
group <- factor(c(1,1,1,1,1,2,2,2,2))
y <- DGEList(counts=x,group=group)
 y <- calcNormFactors(y)
 keep <-rowSums(cpm(y)>=1) >= 4
 y<-y[keep,]
 dim(y)
###[1] 7613    9
x <- read.delim("gene-count-RARO-Tem.5-7.txt", header = T, row.names=1)
group <- factor(c(1,1,1,1,1,2,2,2,2,2,2,2))
y <- DGEList(counts=x,group=group)
 y <- calcNormFactors(y)
 keep <-rowSums(cpm(y)>=1) >= 5
 y<-y[keep,]
 dim(y)
### [1] 5033   12 

x <- read.delim("gene-count-RARO-CD127-CD25+.5-10.txt", header = T, row.names=1)
group <- factor(c(1,1,1,1,1,2,2,2,2,2,2,2,2,2,2))
y <- DGEList(counts=x,group=group)
 y <- calcNormFactors(y)
 keep <-rowSums(cpm(y)>=1) >= 5
 y<-y[keep,]
 dim(y)
 ### [1] 5127   15

x <- read.delim("gene-count-RARO-Tcm.5-6.txt", header = T, row.names=1)
group <- factor(c(1,1,1,1,1,2,2,2,2,2,2))
y <- DGEList(counts=x,group=group)
 y <- calcNormFactors(y)
 keep <-rowSums(cpm(y)>=1) >= 5
 y<-y[keep,]
 dim(y)
### 1] 4673   11

x <- read.delim("gene-count-Tem-CD127-CD25+.7-10.txt", header = T, row.names=1)
group <- factor(c(1,1,1,1,1,1,1,2,2,2,2,2,2,2,2,2,2))
y <- DGEList(counts=x,group=group)
 y <- calcNormFactors(y)
 keep <-rowSums(cpm(y)>=1) >= 6
 y<-y[keep,]
 dim(y)
 ### [1] 5174   17

 x <- read.delim("gene-count-Tem-RA-Tscm.7-4.txt", header = T, row.names=1)
group <- factor(c(1,1,1,1,1,1,1,2,2,2,2))
y <- DGEList(counts=x,group=group)
 y <- calcNormFactors(y)
 keep <-rowSums(cpm(y)>=1) >= 4
 y<-y[keep,]
 dim(y)
### [1] 8376   11

x <- read.delim("gene-count-Tem-Tcm.7-6.txt", header = T, row.names=1)
group <- factor(c(1,1,1,1,1,1,1,2,2,2,2,2,2))
y <- DGEList(counts=x,group=group)
 y <- calcNormFactors(y)
 keep <-rowSums(cpm(y)>=1) >= 6 
 y<-y[keep,]
 dim(y)
### [1] 4862   13

x <- read.delim("gene-count-RA-Tscm-Tcm.4-6.txt", header = T, row.names=1)
group <- factor(c(1,1,1,1,2,2,2,2,2,2))
y <- DGEList(counts=x,group=group)
 y <- calcNormFactors(y)
 keep <-rowSums(cpm(y)>=1) >= 4
 y<-y[keep,]
 dim(y)
### [1] 8081   10

x <- read.delim("gene-count-RA-Tscm-CD127-CD25+.4-10.txt", header = T, row.names=1)
group <- factor(c(1,1,1,1,2,2,2,2,2,2,2,2,2,2))
 y <- DGEList(counts=x,group=group)
 y <- calcNormFactors(y)
 keep <-rowSums(cpm(y)>=1) >= 4
 y<-y[keep,]
 dim(y)
### [1] 8257   14

x <- read.delim("gene-count-Tcm-CD127-CD25+.6-10.txt", header = T, row.names=1)
group <- factor(c(1,1,1,1,1,1,2,2,2,2,2,2,2,2,2,2))
 y <- DGEList(counts=x,group=group)
 y <- calcNormFactors(y)
 keep <-rowSums(cpm(y)>=1) >= 6
 y<-y[keep,]
 dim(y)
### [1] 4935   16

 ### DEG
x <- read.delim("gene-count-PD1-minus-plus-Lag3-plus.txt", header = T, row.names=1)
group <- factor(c(1,1,1,1,1,1,1,1,2,2,2,2,2,2,2))
 y <- DGEList(counts=x,group=group)
 y <- calcNormFactors(y)
 keep <-rowSums(cpm(y)>=1) >= 6
 y<-y[keep,]
 dim(y)
[1] 5696   15

 design<-model.matrix(~0+group) 
 y <- estimateGLMCommonDisp(y,design) 
 y <- estimateGLMTrendedDisp(y,design) 
 y <- estimateGLMTagwiseDisp(y,design) 
 fit<-glmFit(y,design) 
 lrt.2vs1 <- glmLRT(fit, contrast=c(-1,1))
 top2v1 <- topTags(lrt.2vs1, n=50000) 
 write.table(top2v1, "diff2-1.txt", sep="\t")

    samp_10             samp_11             samp_12             samp_13             samp_14             samp_15         
 Min.   :      0.0   Min.   :      0.0   Min.   :      0.0   Min.   :      0.0   Min.   :      0.0   Min.   :      0.0  
 1st Qu.:      0.0   1st Qu.:      0.0   1st Qu.:      0.0   1st Qu.:      0.0   1st Qu.:      0.0   1st Qu.:      0.0  
 Median :      0.0   Median :      0.0   Median :      0.0   Median :      0.0   Median :      0.0   Median :      0.0  
 Mean   :    371.9   Mean   :    403.3   Mean   :    366.7   Mean   :    431.9   Mean   :    433.6   Mean   :    420.8  
 3rd Qu.:      0.0   3rd Qu.:      1.0   3rd Qu.:      0.0   3rd Qu.:      1.0   3rd Qu.:      0.0   3rd Qu.:      0.0  
 Max.   :1530194.0   Max.   :1375762.0   Max.   :1483500.0   Max.   :1884870.0   Max.   :2065405.0   Max.   :1842052.0  
    samp_16             samp_17           samp_18             samp_19              samp_1             samp_20         
 Min.   :      0.0   Min.   :      0   Min.   :      0.0   Min.   :      0.0   Min.   :      0.0   Min.   :      0.0  
 1st Qu.:      0.0   1st Qu.:      0   1st Qu.:      0.0   1st Qu.:      0.0   1st Qu.:      0.0   1st Qu.:      0.0  
 Median :      0.0   Median :      0   Median :      0.0   Median :      0.0   Median :      0.0   Median :      0.0  
 Mean   :    421.7   Mean   :    400   Mean   :    405.3   Mean   :    404.7   Mean   :    372.3   Mean   :    426.4  
 3rd Qu.:      0.0   3rd Qu.:      0   3rd Qu.:      0.0   3rd Qu.:      0.0   3rd Qu.:      0.0   3rd Qu.:      0.0  
 Max.   :1681487.0   Max.   :1638616   Max.   :1721864.0   Max.   :1543003.0   Max.   :1430553.0   Max.   :1883134.0  
    samp_21             samp_22             samp_23             samp_24             samp_25            samp_26         
 Min.   :      0.0   Min.   :      0.0   Min.   :      0.0   Min.   :      0.0   Min.   :     0.0   Min.   :      0.0  
 1st Qu.:      0.0   1st Qu.:      0.0   1st Qu.:      0.0   1st Qu.:      0.0   1st Qu.:     0.0   1st Qu.:      0.0  
 Median :      0.0   Median :      0.0   Median :      0.0   Median :      0.0   Median :     0.0   Median :      0.0  
 Mean   :    335.4   Mean   :    404.3   Mean   :    412.3   Mean   :    406.4   Mean   :   295.6   Mean   :    399.1  
 3rd Qu.:      0.0   3rd Qu.:      0.0   3rd Qu.:      0.0   3rd Qu.:      0.0   3rd Qu.:     0.0   3rd Qu.:      0.0  
 Max.   :1123475.0   Max.   :1826435.0   Max.   :1208528.0   Max.   :1389813.0   Max.   :794973.0   Max.   :1201328.0  
    samp_27             samp_28             samp_29              samp_2             samp_30             samp_31        
 Min.   :      0.0   Min.   :      0.0   Min.   :      0.0   Min.   :      0.0   Min.   :      0.0   Min.   :     0.0  
 1st Qu.:      0.0   1st Qu.:      0.0   1st Qu.:      0.0   1st Qu.:      0.0   1st Qu.:      0.0   1st Qu.:     0.0  
 Median :      0.0   Median :      0.0   Median :      0.0   Median :      0.0   Median :      0.0   Median :     0.0  
 Mean   :    403.9   Mean   :    387.8   Mean   :    380.9   Mean   :    368.8   Mean   :    325.7   Mean   :   368.3  
 3rd Qu.:      0.0   3rd Qu.:      0.0   3rd Qu.:      0.0   3rd Qu.:      0.0   3rd Qu.:      0.0   3rd Qu.:     0.0  
 Max.   :1281936.0   Max.   :1153819.0   Max.   :1032041.0   Max.   :2518526.0   Max.   :1456060.0   Max.   :716138.0  
    samp_32             samp_33             samp_34             samp_35             samp_36             samp_37        
 Min.   :      0.0   Min.   :      0.0   Min.   :      0.0   Min.   :      0.0   Min.   :      0.0   Min.   :     0.0  
 1st Qu.:      0.0   1st Qu.:      0.0   1st Qu.:      0.0   1st Qu.:      0.0   1st Qu.:      0.0   1st Qu.:     0.0  
 Median :      0.0   Median :      0.0   Median :      0.0   Median :      0.0   Median :      0.0   Median :     0.0  
 Mean   :    427.2   Mean   :    409.1   Mean   :    433.5   Mean   :    420.8   Mean   :    398.7   Mean   :   365.6  
 3rd Qu.:      0.0   3rd Qu.:      0.0   3rd Qu.:      0.0   3rd Qu.:      0.0   3rd Qu.:      0.0   3rd Qu.:     0.0  
 Max.   :1434997.0   Max.   :2297688.0   Max.   :2204128.0   Max.   :1901173.0   Max.   :1446624.0   Max.   :921715.0  
    samp_38             samp_39              samp_3            samp_40             samp_41            samp_42         
 Min.   :      0.0   Min.   :      0.0   Min.   :     0.0   Min.   :      0.0   Min.   :     0.0   Min.   :      0.0  
 1st Qu.:      0.0   1st Qu.:      0.0   1st Qu.:     0.0   1st Qu.:      0.0   1st Qu.:     0.0   1st Qu.:      0.0  
 Median :      0.0   Median :      0.0   Median :     0.0   Median :      0.0   Median :     0.0   Median :      0.0  
 Mean   :    393.5   Mean   :    343.9   Mean   :   351.2   Mean   :    403.4   Mean   :   334.4   Mean   :    381.8  
 3rd Qu.:      0.0   3rd Qu.:      0.0   3rd Qu.:     0.0   3rd Qu.:      0.0   3rd Qu.:     0.0   3rd Qu.:      0.0  
 Max.   :2100199.0   Max.   :1935528.0   Max.   :957472.0   Max.   :1260480.0   Max.   :790501.0   Max.   :1162829.0  
    samp_43             samp_44           samp_45           samp_46             samp_47             samp_48         
 Min.   :      0.0   Min.   :      0   Min.   :      0   Min.   :      0.0   Min.   :      0.0   Min.   :      0.0  
 1st Qu.:      0.0   1st Qu.:      0   1st Qu.:      0   1st Qu.:      0.0   1st Qu.:      0.0   1st Qu.:      0.0  
 Median :      0.0   Median :      0   Median :      0   Median :      0.0   Median :      0.0   Median :      0.0  
 Mean   :    417.9   Mean   :    364   Mean   :    362   Mean   :    391.5   Mean   :    419.3   Mean   :    406.1  
 3rd Qu.:      0.0   3rd Qu.:      0   3rd Qu.:      0   3rd Qu.:      0.0   3rd Qu.:      0.0   3rd Qu.:      0.0  
 Max.   :1442305.0   Max.   :1299438   Max.   :1601354   Max.   :1171030.0   Max.   :1122120.0   Max.   :1114650.0  
    samp_49             samp_4            samp_51             samp_52             samp_53            samp_54       
 Min.   :     0.0   Min.   :     0.0   Min.   :      0.0   Min.   :      0.0   Min.   :     0.0   Min.   :      0  
 1st Qu.:     0.0   1st Qu.:     0.0   1st Qu.:      0.0   1st Qu.:      0.0   1st Qu.:     0.0   1st Qu.:      0  
 Median :     0.0   Median :     0.0   Median :      0.0   Median :      0.0   Median :     0.0   Median :      0  
 Mean   :   320.1   Mean   :   351.6   Mean   :    398.2   Mean   :    362.5   Mean   :   329.6   Mean   :    387  
 3rd Qu.:     0.0   3rd Qu.:     0.0   3rd Qu.:      0.0   3rd Qu.:      0.0   3rd Qu.:     0.0   3rd Qu.:      0  
 Max.   :792866.0   Max.   :949730.0   Max.   :1279842.0   Max.   :1290092.0   Max.   :608816.0   Max.   :1158230  
    samp_55             samp_56             samp_57            samp_58             samp_5           samp_60         
 Min.   :      0.0   Min.   :      0.0   Min.   :     0.0   Min.   :     0.0   Min.   :      0   Min.   :      0.0  
 1st Qu.:      0.0   1st Qu.:      0.0   1st Qu.:     0.0   1st Qu.:     0.0   1st Qu.:      0   1st Qu.:      0.0  
 Median :      0.0   Median :      0.0   Median :     0.0   Median :     0.0   Median :      0   Median :      0.0  
 Mean   :    418.1   Mean   :    447.7   Mean   :   364.2   Mean   :   359.9   Mean   :    401   Mean   :    421.3  
 3rd Qu.:      0.0   3rd Qu.:      0.0   3rd Qu.:     0.0   3rd Qu.:     0.0   3rd Qu.:      0   3rd Qu.:      0.0  
 Max.   :1241759.0   Max.   :1510891.0   Max.   :987929.0   Max.   :869152.0   Max.   :1731215   Max.   :1322655.0  
    samp_61             samp_62              samp_6              samp_7              samp_8              samp_9        
 Min.   :      0.0   Min.   :      0.0   Min.   :      0.0   Min.   :      0.0   Min.   :      0.0   Min.   :     0.0  
 1st Qu.:      0.0   1st Qu.:      0.0   1st Qu.:      0.0   1st Qu.:      0.0   1st Qu.:      0.0   1st Qu.:     0.0  
 Median :      0.0   Median :      0.0   Median :      0.0   Median :      0.0   Median :      0.0   Median :     0.0  
 Mean   :    411.7   Mean   :    383.9   Mean   :    397.7   Mean   :    400.2   Mean   :    439.7   Mean   :   381.5  
 3rd Qu.:      0.0   3rd Qu.:      0.0   3rd Qu.:      0.0   3rd Qu.:      0.0   3rd Qu.:      0.0   3rd Qu.:     0.0  
 Max.   :1164949.0   Max.   :1114382.0   Max.   :1066267.0   Max.   :1180572.0   Max.   :1975911.0   Max.   :985456.0  
> 

cat star-HIV-samp-info-two28.txt | grep -w Tem | cut -f 1 > sampID-tem
cat temp-col-samp
1	probe
2	"samp_10"
3	"samp_11"
4	"samp_12"
cat temp1-238-915 ###samples column#
59
9
15
cat t1
1,59,9,15,20,30,44,46,
star-CPM.tem.txt
star-CPM.tcm.txt
bash  script-rm-rows-with-many-0  star-CPM.tem.txt > star-CPM.tem.ge4zeros.txt ###8888 
cat temp-r-out | awk 'NR % 4 == 1 {print $2} ' > temp-1
cat temp-r-out | awk 'NR % 4 == 0 {print $1} ' > temp-2
cat temp-r-out | awk 'NR % 4 == 2  {print $2} ' > temp-3
paste temp-[123] > star-CPM.tem.ge4zeros.spearman.r.pvalue.txt
vi star-CPM.tem.ge4zeros.spearman.r.pvalue.txt
sort GRCh38-geneID-name > temp-1
sort star-CPM.tem.ge4zeros.spearman.r.pvalue.rnk > temp-2
join -t '	' -1 1 -2 1 temp-1 temp-2 | cut -f 2,3 > star-CPM.tem.ge4zeros.spearman.r.pvalue.2.rnk

bash ./tem-script-preRank-genes-signed-FDR temp-tcm-tem-path-res.txt > temp-heatmap
cp -i star-CPM.tcm.tem.pathway.heatmap.txt star-CPM.tcm.tem.pathway.heatmap.filt.txt
Heatmap(matrix = mat, name = "signed logP", column_order = 1:2, column_names_side = "top",  row_names_gp = gpar(fontsize = 7), width= unit(4, "cm"))

bash gsea-cli.sh GSEAPreranked -gmx "/Users/linyongmao/Documents/dir-gene-set-database/c5.all.v7.1.symbols.gmt"   -collapse No_Collapse -mode Max_probe -norm meandiv  -nperm 1000 -rnk "/Users/linyongmao/Documents/antiIL10 monkey/dir-IL10-covid19/dir-belg-scRNAseq/ugent.covid-master/run/bal.bcell.startBelg.cluster4.diff2-1.CvM.Cpos.rnk"  -rpt_label gseareport -create_svgs false -include_only_symbols true   -make_sets true -plot_top_x 1234567 -rnd_seed 1234 -set_max 1500 -set_min 5 -zip_report false -out "/Users/linyongmao/Documents/antiIL10 monkey/dir-IL10-covid19/dir-belg-scRNAseq/ugent.covid-master/advanced"

Heatmap(matrix = mat, name = "signed logP", column_order = column_order, column_names_side = "top",  row_names_gp = gpar(fontsize = 7), height = unit(10, "cm"), width= unit(2, "cm"))

####KG pearson corr
bash  script-rm-rows-with-many-0 star-CPM.tcm.txt > star-CPM.tcm.le1zero.txt #### 5697 
bash script-2-R-correlation.date3-6.pearson.R > temp-r-ip
bash ../script-preRank-genes star-CPM.tcm.le1zero.cor.p.txt > star-CPM.tcm.le1zero.cor.p.rnk.txt
star-CPM.tcm.le1zero.cor.p.rnk

rnkF="/Users/linyongmao/Documents/dir-star-hiv/dir-pearson-cor-pathways/star-CPM.tcm.le1zero.cor.p.rnk"
label0="star-CPM.tcm.le1zero.cor"
gs="h.all.v7.1.symbols.gmt" 
la=`echo "$gs" | sed 's/\.gmt//' | sed 's/\.symbols//' `
label="$label0.$la"
op="temp-$label"
  echo "$label"
  echo "$op"
bash gsea-cli.sh GSEAPreranked -gmx "/Users/linyongmao/Documents/dir-gene-set-database/$gs"   -collapse No_Collapse -mode Max_probe -norm meandiv  -nperm 1000 -rnk "$rnkF"  -rpt_label  "$label" -create_svgs false -include_only_symbols true   -make_sets true -plot_top_x 1234567 -rnd_seed 1234 -set_max 1500 -set_min 5 -zip_report false -out "/Users/linyongmao/gsea_home/output/may05"

####KG pearson corr
###all pathways (+/-) with p < 0.05, TEM, 125 pathways
bash script-generate-chea-target-file-LEG-pathway-2-aug-31-temp | cut -f 2 |awk 'NR > 1' |sort | uniq > temp-tem-p0.05-all-paths.txt
### get nes, p, q for each pathway
bash script-generate-chea-target-file-LEG-pathway-2-sep-01-temp
temp-star-CPM.tem.le1zero.cor.h.all.kegg.reactome.v7.1.GseaPreranked.1599504534797-path-nes-p-q.txt
###get LEGs for each pathway
bash script-generate-chea-target-file-LEG-pathway-3-sep-01
###rm dup. LEGs in a pathway, create chea files
bash script-generate-chea-target-file-LEG-pathway-3-sep-01-step2
####overlap between LEGs of pathways
bash script-generate-chea-target-file-LEG-pathway-3-sep-01-step3 > tem-p0.05-all-paths.net.0
###create networt based on jaccard coeff
bash  script-generate-chea-target-file-LEG-pathway-3-sep-01-step4  tem-p0.05-all-paths.net.0 | sort | uniq > tem-p0.05-all-paths.net.1
###24 clusters
../local_mcl/bin/mcl tem-p0.05-all-paths.net.1  -I 2.0  --abc  -scheme 7
bash script-pathway-clustNum > tem-clust-pathway-degree
bash script-clust-clust-interaction | grep module | awk '$2 != $3'
module	7	11
module	7	12
module	2	5
tem-clust-pathway-degree-2.xls
tem.le1zero.cor.h.all.kegg.reactome.clust.nes.p.q
cat tem.le1zero.cor.h.all.kegg.reactome.clust.nes.p.q | awk 'BEGIN {FS = "\t"; OFS = "\t"} 
{
 nes[$2] += $3;
}
END {
  for (i in nes)
    print i, nes[i];
    }'
tem-net-node-property-module-name
tem-net-node-property-module-size
tem-net-node-property-module-nes-sum

head tem-module.net
7	11
7	12
2	5
anchor	1
anchor	2

f=`awk '$1 == 1' tem-clust-pathway-degree | cut -f 2 | while read ll; do echo -n "temp-lead-genes.$ll.xls  "; done`
cat $f | sort | uniq -c | sort -nr | awk '$1 > 1' |head -50 | awk '{print $2}' > temp-geneName
cat temp-geneName | while read g; do grep "	$g$" ../GRCh38-geneID-name; done > temp-geneName-ID
vi temp-geneName-ID
Heatmap(matrix = mat, name = "mRNA", column_order = column_order, column_names_side = "top",  row_names_gp = gpar(fontsize = 7), height = unit(11, "cm"), width= unit(5, "cm"))

###GLM corr gene expr with HIV
x <- read.delim("gene-count-Tem-7samp.txt", row.names=1)
y <- DGEList(counts=x)
y <- calcNormFactors(y)
d <- cpm(y)
write.table(d, "star-CPM-tem.txt", sep="\t")
keep <-rowSums(cpm(y)>0) >= 6
y<-y[keep,]
dim(y)
####[1] 5659    7
h <- read.delim("../star-CPM.tem.ge4zeros.starID.hiv.inorder.txt", header = F)
hiv <- log10(h$V3)
design<-model.matrix(~hiv) 
y <- estimateGLMCommonDisp(y,design) 
 y <- estimateGLMTrendedDisp(y,design) 
 y <- estimateGLMTagwiseDisp(y,design) 
 fit<-glmFit(y,design) 

lrt.2vs1 <- glmLRT(fit, coef = "hiv")
top2v1 <- topTags(lrt.2vs1, n=50000) 
write.table(top2v1, "diff2-1.txt", sep="\t")

####TCM corr with infection freq#######
cut -f 1-7 ./dir-map-stat/gene-count-Tcm-CD127-CD25+.6-10.txt > gene-count-Tcm.6samp.txt
x <- read.delim("gene-count-Tcm.6samp.txt", row.names=1)
y <- DGEList(counts=x)
y <- calcNormFactors(y)
keep <-rowSums(cpm(y)>0) >= 5
y<-y[keep,]
dim(y)
###[1] 5696    6
h <- read.delim("star-CPM.tcm.hiv.inorder.txt", header = F) ##log10 transformed
hiv <- h$V3
design<-model.matrix(~hiv) 
y <- estimateGLMCommonDisp(y,design) 
 y <- estimateGLMTrendedDisp(y,design) 
 y <- estimateGLMTagwiseDisp(y,design) 
 fit<-glmFit(y,design) 

lrt.2vs1 <- glmLRT(fit, coef = "hiv")
top2v1 <- topTags(lrt.2vs1, n=50000) 
write.table(top2v1, "diff2-1.txt", sep="\t")

##rm star012, female sample
cut -f 1,3-7 ./dir-map-stat/gene-count-Tcm-CD127-CD25+.6-10.txt > temp-gene-count
> keep <-rowSums(cpm(y)>0) >= 4
> y<-y[keep,]
> dim(y)
[1] 5918    5
> h <- read.delim("star-CPM.tcm.hiv.inorder.txt", header = F) ##log10 transformed
> hiv <- h$V3[2:6]
star-CPM.tcm.GLM.hiv.diff2-1.5samps.txt
star-CPM.tcm.GLM.hiv.diff2-1.5samps.name.rnk

#TEM infect freq
cat dir-map-stat/gene-count-Tem-RA-Tscm.7-4.txt | cut -f 1,2,3,4,5,8 > gene-count-Tem-5samp.infect.txt
x <- read.delim("gene-count-Tem-5samp.infect.txt", row.names=1)
group <- factor(rep(1, 5))
y <- DGEList(counts=x,group=group)
y <- calcNormFactors(y)
keep <-rowSums(cpm(y)>0) >= 4
y<-y[keep,]
dim(y)
##[1] 6754    5
h <- read.delim("tem-infect.freq.2", header = F)
hiv <- log10(h$V6)
design<-model.matrix(~hiv)
y <- estimateGLMCommonDisp(y,design)
 y <- estimateGLMTrendedDisp(y,design)
 y <- estimateGLMTagwiseDisp(y,design)
 fit<-glmFit(y,design)

lrt.2vs1 <- glmLRT(fit, coef = "hiv")
top2v1 <- topTags(lrt.2vs1, n=50000)
write.table(top2v1, "diff2-1.txt", sep="\t")
mv -i diff2-1.txt star-CPM.tem.GLM.hiv.diff2-1.txt
star-CPM-tem.5samp.infect.txt
tem-infect.freq.transpose.txt
Heatmap(matrix = log10(mat), name = "log10(hiv)",   column_names_side = "top",   show_row_names = T,  column_order=c(5,1,2,4,3), height = unit(0.6, "cm"), width= unit(6, "cm"), col=col_fun)

cat gene-count-Tem-5samp.infect.txt | cut -f 1-5 > gene-count-Tem-4samp.infect.txt
keep <-rowSums(cpm(y)>0) >= 3
> y<-y[keep,]
> dim(y)
[1] 8178    4

#TCM TEM 11 samples , HIV infect freq
paste gene-count-Tcm.6samp.txt  gene-count-Tem-5samp.infect.txt | cut -f 1-7,9-13 > gene-count-Tcm-Tem.6-5samp.infect.txt ###cloum1 == colum8, checked
x <- read.delim("gene-count-Tcm-Tem.6-5samp.infect.txt", row.names=1)
group <- factor(c(rep(1, 6), rep(2, 5)))
y <- DGEList(counts=x,group=group)
y <- calcNormFactors(y)
keep <-rowSums(cpm(y)>0) >= 10
y<-y[keep,]
dim(y)
###[1] 4178   11
cut -f 1-2 star-CPM.tcm.hiv.inorder.txt > temp1
cut -f 1,6 tem-infect.freq.2 > temp2
cat temp1 temp2 > tcm-tem-infect.freq.2 
vi tcm-tem-infect.freq.2 
h <- read.delim("tcm-tem-infect.freq.2", header = F)
hiv <- log10(h$V2)
design<-model.matrix(~hiv)
y <- estimateGLMCommonDisp(y,design)
 y <- estimateGLMTrendedDisp(y,design)
 y <- estimateGLMTagwiseDisp(y,design)
 fit<-glmFit(y,design)

lrt.2vs1 <- glmLRT(fit, coef = "hiv")
top2v1 <- topTags(lrt.2vs1, n=50000)
write.table(top2v1, "diff2-1.txt", sep="\t")
mv -i "diff2-1.txt" star-CPM.tcm.tem.GLM.hiv.diff2-1.txt
 star-CPM.tcm.tem.GLM.hiv.diff2-1.allGenes.name.txt
 cat  star-CPM.tcm.tem.GLM.hiv.diff2-1.allGenes.name.txt | awk 'BEGIN {FS = "\t"; OFS = "\t"} {print $8,$1,$2,$3,$4,$5,$6}' > temp-name-updown-p

"tcm-tem-infect.freq.2.transpose"
star-CPM.tcm.tem.GLM.hiv.name.rnk

> Heatmap(matrix = log10(mat), name = "log10(hiv)",   column_names_side = "top",   show_row_names = T,  column_order= c(11, 1, 7, 4, 8, 5, 2, 10, 6, 3, 9), height = unit(0.6, "cm"), width= unit(6, "cm"), col=col_fun)

> x <- read.delim("gene-count-Tem-5samp.infect.txt", row.names=1)
> group <- factor(c(rep(2, 5)))
> y <- DGEList(counts=x,group=group)
> y <- calcNormFactors(y)
> keep <-rowSums(cpm(y)>0) >= 4
> y<-y[keep,]
> dim(y)
[1] 6754    5

bash script-gsea-star-hiv 
cat "$f" | awk 'BEGIN {FS = "\t"; OFS = "\t"} $7 < 0.05' | cut -f 1 > TFnames-neg.corr.tcm.tem.hiv
TFnames-pos.corr.tcm.tem.hiv
cat temp > temp-tf-tf-chea
"../antiIL10 monkey/dir-IL10-covid19/dir-belg-scRNAseq/ugent.covid-master/run/scrnaseq-metaannot-combine" temp-tf-tf-chea star-CPM.tcm.tem.GLM.hiv.name.rnk out
"../antiIL10 monkey/dir-IL10-covid19/dir-belg-scRNAseq/ugent.covid-master/run/scrnaseq-metaannot-combine" temp-tf-tf-chea temp-name-updown-p out
cat out   | awk 'BEGIN {FS = "\t"; OFS = "\t"} $6 < 0.05 && $3 < 0&& $4 > 0' | cut -f 1 > TFnames-neg.corr.tcm.tem.hiv.selected.with.expr
TFnames-neg.corr.tcm.tem.hiv.selected.with.expr.2
TF-target-neg.corr.tcm.tem.hiv.txt

##diff star-CPM.tcm.GLM.hiv.diff2-1.txt diff2-1.txt | wc -l
       0

h <- read.delim("star-CPM.tcm.hiv.inorder.transpose.txt", header = T, row.names=1)
star-CPM.tcm.GLM.hiv.diff2-1.txt ###GLM DEGs
"star-CPM-tcm.11-15.txt" ###TCM gene CPM
star-CPM.tcm.GLM.hiv.diff2-1.50neg.corr.genes.name
star-CPM.tcm.GLM.hiv.diff2-1.50pos.corr.genes.names ##51 genes
star-CPM.tcm.GLM.hiv.diff2-1.p0.05.corr.genes
star-CPM.tcm.GLM.hiv.diff2-1.p0.05.neg.corr.genes

a <- read.delim(file = "star-CPM-tcm.11-15.txt", header = T, row.names=1)
mv -i temp.2 star-CPM-tcm.11-15.zscore.txt
mv -i "temp.2" star-CPM-tcm.11-15.log10.x+1.zscore.txt

rna <- read.delim(file = "star-CPM-tcm.11-15.zscore.txt", header = T, row.names=1)
rna <- read.delim(file = "star-CPM-tcm.11-15.log10.x+1.zscore.txt", header = T, row.names=1)
cut -f 1 star-CPM.tcm.GLM.hiv.diff2-1.45pos.corr.genes | sed 's/"//g' |while read g; do grep -w $g GRCh38-geneID-name ; done > star-CPM.tcm.GLM.hiv.diff2-1.45pos.corr.genes.name
star-CPM.tcm.GLM.hiv.diff2-1.50neg.corr.genes.name
Heatmap(matrix = mat, name = "mRNA", column_order = order(c(1,4,6,2,3,5)), column_names_side = "bottom",  row_names_gp = gpar(fontsize = 6), height = unit(10, "cm"), width= unit(6, "cm")) ### column_order, TCM based on the infection freq order - lowest to highest

bash ./script-preRank-genes star-CPM.tcm.GLM.hiv.diff2-1.txt > star-CPM.tcm.GLM.hiv.diff2-1.rnk
"../antiIL10 monkey/dir-IL10-covid19/dir-belg-scRNAseq/ugent.covid-master/run/scrnaseq-metaannot-combine" star-CPM.tcm.GLM.hiv.diff2-1.rnk GRCh38-geneID-name out
paste star-CPM.tcm.GLM.hiv.diff2-1.rnk out > temp
paste star-CPM.tcm.GLM.hiv.diff2-1.rnk out | awk 'BEGIN {FS = "\t"; OFS = "\t"} {print $4, $2}' > star-CPM.tcm.GLM.hiv.diff2-1.name.rnk
bash ./script-gsea-cmds-2-oct-2020
paste  star-CPM.tcm.GLM.hiv.diff2-1.txt   out | grep -v notApplicable |awk 'BEGIN {FS = "\t"; OFS = "\t"} $2 < 0 {print $1, $8, $5, $6}' > temp.txt

###positive DEGS overlapped with genesets
genome="tcm.genome.5695genes"
cat "$genome" | awk '{print toupper($1)}' | sort | uniq > temp
mv temp genes-20656.txt
#5695 genes-20656.txt
bash script-generate-chea-target-file
sort temp | uniq > temp-lead-genes.tcm.pos.corr.p0.05.xls 
bash script-TF-targets-enrich > IL10-aIL10-up-down.h.all.path-overlap.txt
bash "../antiIL10 monkey/dir-TF-db/script-hyperG-test-2-R" IL10-aIL10-up-down.h.all.path-overlap.txt > temp-r-input
Rscript temp-r-input > temp-r-res
cat temp-r-res | awk '{print $2}' > IL10-aIL10-up-down.h.all.path-overlap.p-value.txt
vi IL10-aIL10-up-down.h.all.path-overlap.p-value.txt
paste IL10-aIL10-up-down.h.all.path-overlap.txt IL10-aIL10-up-down.h.all.path-overlap.p-value.txt  |awk 'BEGIN {FS = "\t"; OFS = "\t"} $7 < 0.05 && $3 > 1' 
paste IL10-aIL10-up-down.h.all.path-overlap.txt IL10-aIL10-up-down.h.all.path-overlap.p-value.txt  |awk 'BEGIN {FS = "\t"; OFS = "\t"} $7 < 0.25 && $3 > 1'
tcm.pos.corr.p0.05	GLI1	2	163	11	5695	0.03779621
tcm.pos.corr.p0.05	HALLMARK_MYOGENESIS	3	163	32	5695	0.06231397
tcm.pos.corr.p0.05	KEGG_ECM_RECEPTOR_INTERACTION	2	163	8	5695	0.02035347
tcm.pos.corr.p0.05	KEGG_TIGHT_JUNCTION	2	163	30	5695	0.211478
tcm.pos.corr.p0.05	REACTOME_DEGRADATION_OF_CYSTEINE_AND_HOMOCYSTEINE	2	163	3	5695	0.002396881
tcm.pos.corr.p0.05	REACTOME_G_ALPHA_I_SIGNALLING_EVENTS	3	163	55	5695	0.2077969
tcm.pos.corr.p0.05	REACTOME_NEGATIVE_EPIGENETIC_REGULATION_OF_RRNA_EXPRESSION	2	163	27	5695	0.180021
tcm.pos.corr.p0.05	REACTOME_SULFUR_AMINO_ACID_METABOLISM	2	163	5	5695	0.007692188
tcm.pos.corr.p0.05	REACTOME_VISUAL_PHOTOTRANSDUCTION	2	163	13	5695	0.05164341
tcm.pos.corr.p0.05	ZNF263	3	163	28	5695	0.04467652
#CSAD gene target of ZNF263 & cystein metabolism
###CD4 memory or TCM, CM
cat "$f" | awk 'BEGIN {FS = "\t"; OFS = "\t"} $8 < 0.05' | grep -i mem   |grep -iv cd8  | grep -iv bcell | sort > temp.xls

###
Tem-Tcm.diff2-1.txt.withGeneNames
cat  dir-map-stat/Tem-Tcm.diff2-1.txt | awk 'BEGIN {FS = "\t"; OFS = "\t"} $6 < 0.05 && $2 > 0'   ### TCM up genes
##9 genes up in TEM with FDR < 0.05
cat  dir-map-stat/Tem-Tcm.diff2-1.txt | awk 'BEGIN {FS = "\t"; OFS = "\t"}  $2 < 0' | head -51 > Tem-Tcm.tem-up.50genes

####5 memory subsets
cat dir-map-stat/gene-count-Tem-RA-Tscm.7-4.txt | cut -f 1,9-12 > temp.1.txt
paste temp.1.txt dir-map-stat/gene-count-Tem-Tcm.7-6.txt dir-map-stat/gene-count-RARO-CD127-CD25+.5-10.txt > temp.2.txt
cat  temp.2.txt | cut -f 1-5,7-14,16-19,21-35 > gene-count-Tscm-Tem-Tcm-RARO-CD127-CD25+.noS21.txt
# cat  temp.2.txt | cut -f 1-5,7-15,16-19,21-35 > gene-count-Tscm-Tem-Tcm-RARO-Treg.32samp.txt

> rawCount <- read.delim("../gene-count-Tscm-Tem-Tcm-RARO-CD127-CD25+.noS21.txt", header = T, row.names = 1)
> group <- factor(rep(1, 31))
y <- DGEList(counts=rawCount,group=group)
y <- calcNormFactors(y)
d <- cpm(y)
> genes <- read.delim("../random-6044genes", header=F)
mat <- as.matrix(d[genes$V1,])
medianFilt = rawCount ###data frame
medianFilt$med <- apply(d, 1, FUN=median) ### d is cpm,
d.med.gt1 <- d[medianFilt$med > 1,]
mat <- as.matrix(d.med.gt1)
> ha <- HeatmapAnnotation(type = annot)
Heatmap(matrix = log10(mat+1), name = "log10(CPM+1)",   column_names_side = "top",  top_annotation = ha,  show_row_names = F,   col = col_fun, clustering_distance_columns="pearson")
> yfilt <- y[medianFilt$med > 1,]
mds1 = plotMDS(yfilt, top = 91234)

##5 memory subsets, 32 samples, PVCA
rawCount <- read.delim("gene-count-Tscm-Tem-Tcm-RARO-Treg.32samp.txt", row.names=1)
dim(rawCount)
 group <- factor(rep(1, 32))
 y <- DGEList(counts=rawCount,group=group)
 y <- calcNormFactors(y)
 d <- cpm(y)
 summary(log2(d+1))
pData <- read.delim("Tscm-Tem-Tcm-RARO-Treg.32samp.info.txt", header = T, row.names = 1)
phenoData <- AnnotatedDataFrame(data=pData)
eset <- ExpressionSet(log2(d+1), phenoData=phenoData)
 ### eset <- ExpressionSet(d, phenoData=phenoData)
 pct_threshold <- 0.6
batch.factors <- c("genesDet", "subtypr",  "donor")

pvcaObj <- pvcaBatchAssess (eset, batch.factors, pct_threshold) 
##Error: number of levels of each grouping factor must be < number of observations (problems: subtypr:donor, genesDet:donor, genesDet:subtypr, genesDet)

 bp <- barplot(pvcaObj$dat,  xlab = "Effects", 
 	ylab = "Weighted average proportion variance", 
 	ylim= c(0,1.1),col = c("blue"), las=2, 
 	main="PVCA estimation bar chart")
 axis(1, at = bp, labels = pvcaObj$label, xlab = "Effects", cex.axis = 0.5, las=2)
 values = pvcaObj$dat
 new_values = round(values , 3)
 text(bp,pvcaObj$dat,labels = new_values, pos=3, cex = 0.8) 



###head  Tscm-Tem-Tcm-RARO-Treg.32samp.info.txt 
	genesDet	subtypr	donor
samp_13	15747	CD4+ RA-Tscm	STAR010
samp_23	12719	CD4+ RA-Tscm	STAR012
samp_28	12119	CD4+ RA-Tscm	STAR008


rawCount <- read.delim("../gene-count-Tscm-Tem-Tcm.noS21.txt", header = T, row.names = 1)
group <- factor(rep(1, 16))
y <- DGEList(counts=rawCount,group=group)
y <- calcNormFactors(y)
d <- cpm(y)
medianFilt = rawCount ###data frame
medianFilt$med <- apply(d, 1, FUN=median) ### d is cpm,
d.med.gt1 <- d[medianFilt$med > 1,]
a <- log10(d.med.gt1+1)
b = a
for(i in 1:dim(b)[1])
{
 a[i, ] <- (a[i, ] - mean(as.numeric(b[i,]))) / var(as.numeric(b[i,]))^(1/2) 
}
write.table(a,file="temp.log10.z.tscm.tem.tcm.txt", sep = "\t", quote = F)
dim(a)
####[1] 5674   16
####first field of 1st line
vi dir-map-stat/temp.log10.z.tscm.tem.tcm.txt 
"../antiIL10 monkey/dir-IL10-covid19/dir-belg-scRNAseq/ugent.covid-master/run/scrnaseq-metaannot-combine" dir-map-stat/temp.log10.z.tscm.tem.tcm.txt GRCh38-geneID-name out
paste out dir-map-stat/temp.log10.z.tscm.tem.tcm.txt  | grep -v notApplicable | cut -f 2,4-100 > temp.log10.z.tscm.tem.tcm.genename.txt
cat /Users/linyongmao/Documents/dir-gene-set-database/LM22.gmt > temp-lm22.gmt
vi temp-lm22.gmt  ###1 line -> 22 lines
rm temp-lead-genes.*.xls
####generate temp-lead-genes.MONOCYTES.xls file; each pathway a list of genes (symbols)
bash script-generate-chea-target-file  temp-lm22.gmt
cat diff-CM-EM-p-value.florida.12-14.withName.txt | awk 'BEGIN {FS = "\t"; OFS = "\t"} $2 < 0 ' |head -201 | cut -f 8 > temp-lead-genes.FL_TEMdown200genes.xls
cat diff-CM-EM-p-value.florida.12-14.withName.txt | awk 'BEGIN {FS = "\t"; OFS = "\t"} $2 > 0 ' |head -200 | cut -f 8 > temp-lead-genes.FL_TEMup200genes.xls
bash script-generate-chea-target-file /Users/linyongmao/Documents/dir-gene-set-database/h.all.v7.1.symbols.gmt
bash script-pathway-exprAvg-ln-hallmark-2 > temp-pathway-exprAvg-1
cat temp-pathway-exprAvg-1 | awk 'NF > 10' | awk '$1 >= 25' | grep HALLMARK | cut -f 2-20 > out
cat temp-pathway-exprAvg-1 | awk 'NF > 10' | awk '$1 >= 25' | grep T_CELLS_CD4 | cut -f 2-20 >> out
mv -i out temp-pathway-exprAvg-2

### Tem-Tcm, rm sample 12, 21 in TCM
x <- read.delim("gene-count-Tem-Tcm.7-6.txt", header = T, row.names=1)
rawCount <- x[,c(1:7,10:13)] ###rm sample 12, 21 in TCM
group <- factor(c(rep(1, 7), rep(2, 4)))
 y <- DGEList(counts=rawCount,group=group)
 y <- calcNormFactors(y)
 keep <-rowSums(cpm(y)>=1) >= 4
 y<-y[keep,]
 dim(y)
### [1] 5994   11
 design<-model.matrix(~0+group) 
 y <- estimateGLMCommonDisp(y,design) 
 y <- estimateGLMTrendedDisp(y,design) 
 y <- estimateGLMTagwiseDisp(y,design) 
 fit<-glmFit(y,design) 
 lrt.2vs1 <- glmLRT(fit, contrast=c(-1,1))
 top2v1 <- topTags(lrt.2vs1, n=150000) 
 write.table(top2v1, "diff2-1.txt", sep="\t")
mv -i dir-map-stat/diff2-1.txt Tem-Tcm.7-4.diff2-1.txt
"../antiIL10 monkey/dir-IL10-covid19/dir-belg-scRNAseq/ugent.covid-master/run/scrnaseq-metaannot-combine" Tem-Tcm.7-4.diff2-1.txt GRCh38-geneID-name out
paste out Tem-Tcm.7-4.diff2-1.txt  | grep -v notApplicable | cut -f 2,4-100 > Tem-Tcm.7-4.diff2-1.geneName.txt 

cut -f 8  diff-CM-EM-p-value.florida.12-14.withName.txt | grep -v notApplicable | sort | uniq > temp-1
cat Tem-Tcm.diff2-1.txt.withGeneNames |  grep -v notApplicable |cut -f 8 | sort | uniq > temp-2
cat Tem-Tcm.7-4.diff2-1.geneName.txt |  grep -v notApplicable |cut -f 1| sort | uniq > temp-2
cat temp-1 temp-2| sort | uniq| wc -l
cat Tem-Tcm.7-4.diff2-1.geneName.txt |  grep -v notApplicable | awk 'BEGIN {FS = "\t"; OFS = "\t"} $5 < 0.05 && $2 > 0' | cut -f 1 |sort | uniq > temp-star-tcm-up-7-4samples.txt
cat Tem-Tcm.7-4.diff2-1.geneName.txt |  grep -v notApplicable | awk 'BEGIN {FS = "\t"; OFS = "\t"} $5 < 0.05 && $2 < 0' | cut -f 1 |sort | uniq > temp-star-tem-up-7-4samples.txt

bash script-hyperG-test-2-R temp.txt > out

####FL cohort
rawCount <- read.delim("../Florida-cohort-RT/raw.modify.CM-EM-ordered.txt", header = T, row.names=1)
group <- factor(c(rep(1, 16), rep(2, 16)))
y <- DGEList(counts=rawCount,group=group)
y <- calcNormFactors(y)
d <- cpm(y)
medianFilt = rawCount ###data frame
medianFilt$med <- apply(d, 1, FUN=median) ### d is cpm,
d.med.gt1 <- d[medianFilt$med > 1,]
a <- log10(d.med.gt1+1)
b = a
for(i in 1:dim(b)[1])
{
 a[i, ] <- (a[i, ] - mean(as.numeric(b[i,]))) / var(as.numeric(b[i,]))^(1/2)
}
write.table(a,file="temp.FL.log10.z.tscm.tem.tcm.txt", sep = "\t", quote = F)
dim(a)
##[1] 12733    32
vi  dir-map-stat/temp.FL.log10.z.tscm.tem.tcm.no.version.txt 
"../antiIL10 monkey/dir-IL10-covid19/dir-belg-scRNAseq/ugent.covid-master/run/scrnaseq-metaannot-combine"  dir-map-stat/temp.FL.log10.z.tscm.tem.tcm.no.version.txt GRCh38-geneID-name out
paste out  dir-map-stat/temp.FL.log10.z.tscm.tem.tcm.no.version.txt | grep -v notApplicable | cut -f 2,4-100 > temp.FL.log10.z.tscm.tem.tcm.no.version.genename.txt
grep -wv Y_RNA temp.FL.log10.z.tscm.tem.tcm.no.version.genename.txt > temp.FL.log10.z.tscm.tem.tcm.no.version.genename.2.txt
FL.log10.z.tscm.tem.tcm.no.version.uniq.genename.2.txt ###only unique genes (uniq GRCh gene ID mapped to one gene)
bash script-pathway-exprAvg-ln-hallmark-2 > temp-pathway-exprAvg-1-FL
cat temp-pathway-exprAvg-1-FL | awk 'NF > 10' | awk '$1 >= 25' | grep HALLMARK | cut -f 2-34 > out
cat temp-pathway-exprAvg-1-FL | awk 'NF > 10' | awk '$1 >= 25' | grep T_CELLS_CD4 | cut -f 2-34 >> out
cat temp-pathway-exprAvg-1-FL | awk 'NF > 10' | awk '$1 >= 25' | grep FL_TEM | cut -f 2-34 >> out
mv -i out temp-pathway-exprAvg-2-FL
rna <- read.delim(file = "../temp-pathway-exprAvg-2-FL", row.names=1)
for(i in 1:dim(rna)[1])
{
 res <- t.test(rna[i,1:16], rna[i,17:32]);
 a <- paste(rownames(rna)[i], res$p.value, res$estimate[1], res$estimate[2], sep = "\t")
 print(a)
}

###testing the pipeline of pathway avg gene expr
"../antiIL10 monkey/dir-IL10-covid19/dir-belg-scRNAseq/ugent.covid-master/run/scrnaseq-metaannot-combine" temp-lead-genes.HALLMARK_INTERFERON_GAMMA_RESPONSE.xls temp.log10.z.tscm.tem.tcm.genename.txt out
paste temp-lead-genes.HALLMARK_INTERFERON_GAMMA_RESPONSE.xls  out | grep -v notApplicable > temp.txt ##102 genes


e = "TEM"
c = "TCM"
annot <- c(e,e,e,e,e,e,e,c,c,c,c,c,c)
annot <- c(rep("TCM", 16), rep("TEM", 16))
annot <- c(rep("TSCM", 4),rep("TEM", 7), rep("TCM", 5), rep("RARO", 5), rep("Treg", 10))
ha <- HeatmapAnnotation(type = annot, col = list(type =c("TSCM" = "green", "TEM" = "red", "TCM" = "yellow", "RARO" =  "blue", "Treg" = "black")))
col_fun = colorRamp2(c(0, log10(2), 3), c("blue",  "white", "red"))
 col_fun = colorRamp2(c(0, log10(2), 4), c("blue",  "white", "red"))
col_fun = colorRamp2(c(0, log10(1+1e-9),log10(2), 4), c("green","blue",  "white", "red"))
column_order=order(c(1:4, 10:16,5:9)) ###4 TSCM samples, then 5 TCM samples, then 7 TEM samples
genes <- read.delim("../diff-CM-EM-p-value.florida.12-14.DEGs.direction", header = T)
genes <- read.delim("../diff-CM-EM-p-value.florida.12-14.DEGs.direction.no.4.forSTAR", header = T)
Heatmap(matrix = log10(mat+1), name = "log10(CPM+1)",  column_order = 1:13, column_names_side = "top",  row_names_gp = gpar(fontsize = 8), height = unit(14, "cm"), width= unit(6, "cm"), top_annotation = ha, col= col_fun)
Heatmap(matrix = log10(mat+1), name = "log10(CPM+1)",   column_names_side = "top",  top_annotation = ha,  show_row_names = F,   col = col_fun, row_split=genes$dir)
Heatmap(matrix = log10(mat.star+1), name = "log10(CPM+1)",   column_names_side = "top",  top_annotation = ha.star,  show_row_names = F,   col = col_fun,  clustering_distance_columns="pearson")
Heatmap(matrix = mat,  column_names_side = "top",  row_names_gp = gpar(fontsize = 5.5), column_names_gp= gpar(fontsize = 8), clustering_distance_rows="pearson", top_annotation = ha, clustering_distance_columns="pearson", name = "z-score") ###92 genes, 32 samples, FL

x <- read.delim("../Florida-cohort-RT/raw.modify.CM-EM-ordered.txt", header = T, row.names=1)
group <- factor(c(rep(1, 16), rep(2, 16)))
y <- DGEList(counts=x,group=group)
y <- calcNormFactors(y)
keep <-rowSums(cpm(y)>=1) >= 12
y<-y[keep,]
dim(y)
##[1] 13962    32
mv dir-map-stat/diff2-1.txt diff-CM-EM-p-value.florida.12-14.txt
Dec 14 01:15 dir-map-stat/temp-12-14-2020-florida-cohort-cpm.txt
diff-CM-EM-p-value.florida.12-14.DEGs.direction
diff-CM-EM-p-value.florida.12-14.DEGs.direction.no.4.forSTAR ###some gene IDs from FL do not appear in the STAR IDs

#####Florida CM subset tilda
"../antiIL10 monkey/dir-IL10-covid19/dir-belg-scRNAseq/ugent.covid-master/run/scrnaseq-metaannot-combine"   FL-CM-tilda FL-donon-sample-info  out-tildaOrder-samp
cat  out-tildaOrder-samp | cut -f 2 > temp-samp-cm
head ./Florida-cohort-RT/raw.modify.CM-EM-ordered.txt | head -1 | awk 'BEGIN {FS = "\t"; OFS = "\t"} {for(i = 1; i <= NF; i++) print  $i, i}' | sed 's/"//g' > temp-samp-columNum
 "../antiIL10 monkey/dir-IL10-covid19/dir-belg-scRNAseq/ugent.covid-master/run/scrnaseq-metaannot-combine"   temp-samp-cm temp-samp-columNum out
cat ./Florida-cohort-RT/raw.modify.CM-EM-ordered.txt |  awk 'BEGIN {FS = "\t"; OFS = "\t"}
{
 print $1,     $10,    $11,    $6,     $14,    $16,    $15,    $13,    $12;
}' > FL-genecount-CM-8samps-tilda.txt
 FL-genecount-EM-9samps-tilda.txt
 FL-EM-tilda 
#keep <-rowSums(cpm(y)>1) >= 3; 14312     9
 mv -i "diff2-1.txt" FL-EM-9samps-tilda.diff2-1.txt
FL-genecount-CM-8samps-EM-9samps-tilda.txt
 FL-CM-EM-tilda
> keep <-rowSums(cpm(y)>1) >= 5
>  y<-y[keep,]
>  dim(y)
[1] 14972    17

 x <- read.delim("FL-genecount-CM-8samps-tilda.txt", row.names=1)
 group <- factor(rep(1, 8))
 y <- DGEList(counts=x,group=group)
 y <- calcNormFactors(y)
keep <-rowSums(cpm(y)>1) >= 3
 y<-y[keep,]
 dim(y)
###[1] 14856     8
 h <- read.delim("FL-CM-tilda", header = F)
 h
 hiv <- log10(h$V2)
 hiv
###[1] 0.0000000 0.0000000 0.4313638 1.0576661 1.1760913 1.2552725 1.6665180 1.9294189
 design<-model.matrix(~hiv)
 y <- estimateGLMCommonDisp(y,design)
  y <- estimateGLMTrendedDisp(y,design)
  y <- estimateGLMTagwiseDisp(y,design)
  fit<-glmFit(y,design)
 
 lrt.2vs1 <- glmLRT(fit, coef = "hiv")
 top2v1 <- topTags(lrt.2vs1, n=50000)
 write.table(top2v1, "diff2-1.txt", sep="\t")

mv -i diff2-1.txt FL-CM-8samps-tilda.diff2-1.txt 
FL-CM-8samps-tilda.diff2-1.name.txt
FL-CM-8samps-tilda.diff2-1.rnk
FL-CM-8samps-tilda.noDot.rnk
####ENSG00000155090.12 -> ENSG00000155090
FL-CM-8samps-tilda.noDot.name.rnk
grep -v "notApplicable" FL-CM-8samps-tilda.noDot.name.rnk > temp
mv temp  FL-CM-8samps-tilda.noDot.name.rnk
"/Users/linyongmao/Documents/antiIL10 monkey/dir-IL10-covid19/table-transpose" "FL-CM-tilda" FL-CM-tilda-transpose.txt
FL-CM-8samps-tilda.top50neg-top50pos-corr-genes.id.name ## ENSG00000134107.4	BHLHE40
> Heatmap(matrix = log10(mat[51:100,]+1), name = "log10(CPM+1)",  column_order = 1:8, column_names_side = "bottom",  row_names_gp = gpar(fontsize = 6), height = unit(10, "cm"), width= unit(6, "cm"),  col= col_fun)

###FL EM CM with intDNA
head FL-donon-sample-info*  FL-int-DNA-CM-EM
"../antiIL10 monkey/dir-IL10-covid19/dir-belg-scRNAseq/ugent.covid-master/run/scrnaseq-metaannot-combine" FL-int-DNA-CM-EM FL-donon-sample-info out
paste FL-int-DNA-CM-EM out | grep "	CM	.*	CM$" > temp1
"../antiIL10 monkey/dir-IL10-covid19/dir-belg-scRNAseq/ugent.covid-master/run/scrnaseq-metaannot-combine" FL-int-DNA-CM-EM FL-donon-sample-info-EM out
paste FL-int-DNA-CM-EM out | grep "       EM      .*      EM$" > temp2
cat temp1 temp2 > FL-int-DNA-CM-EM-samp-donor
cat FL-int-DNA-CM-EM-samp-donor | sort +2 -3n > FL-int-DNA-CM-EM-samp-donor-sortedHIV
cut -f 5 FL-int-DNA-CM-EM-samp-donor-sortedHIV > temp-samp-sortedHIV 
head -1 ./Florida-cohort-RT/raw.modify.CM-EM-ordered.txt | awk 'BEGIN {FS = "\t"; OFS = "\t"} {for(i = 1; i <= NF; i++) print  $i, i}'  | sed 's/"//g' > temp1
"../antiIL10 monkey/dir-IL10-covid19/dir-belg-scRNAseq/ugent.covid-master/run/scrnaseq-metaannot-combine" temp-samp-sortedHIV temp1 out
paste  temp-samp-sortedHIV out | cut -f 3 | awk 'BEGIN {FS = "\t"; OFS = "\t"; ORS = ""} {print "$" $1 ","}' 
cat ./Florida-cohort-RT/raw.modify.CM-EM-ordered.txt |  awk 'BEGIN {FS = "\t"; OFS = "\t"}
{print $1,$7,$23,$8,$26,$9,$10,$24,$16,$22,$6,$25,$12,$13,$27,$15,$14,$17,$11,$33,$28,$30,$32,$29,$31;
}' > FL-genecount-CM-EM-24samp-intDNA.txt
x <- read.delim("FL-genecount-CM-EM-24samp-intDNA.txt", row.names=1)
 temp <- read.delim("FL-int-DNA-CM-EM-samp-donor-sortedHIV", header = F)
 group <- factor(temp$V6)
 y <- DGEList(counts=x,group=group)
 y <- calcNormFactors(y)
 keep <-rowSums(cpm(y)>1) >= 7
 y<-y[keep,]
 dim(y)
###[1] 14894    24
 hiv <- log10(temp$V3)
design<-model.matrix(~hiv)
y <- estimateGLMCommonDisp(y,design)
 y <- estimateGLMTrendedDisp(y,design)
 y <- estimateGLMTagwiseDisp(y,design)
 fit<-glmFit(y,design)

lrt.2vs1 <- glmLRT(fit, coef = "hiv")
top2v1 <- topTags(lrt.2vs1, n=50000)
write.table(top2v1, "diff2-1.txt", sep="\t")
mv -i "diff2-1.txt" FL-CM-EM-24samp-intDNA.diff2-1.txt
FL-int-DNA-CM-EM-sortedHIV.transpose
cat  FL-int-DNA-CM-EM-samp-donor-sortedHIV | grep -w CM |  cut -f 5 > temp-samp-sortedHIV 
FL-genecount-CM-12samp-intDNA.txt ###print $1,$7,$8,$9,$10,$16,$6,$12,$13,$15,$14,$17,$11;
FL-int-DNA-CM-EM-samp-donor-sortedHIV-CM
......
>  keep <-rowSums(cpm(y)>1) >= 4
>  y<-y[keep,]
>  dim(y)
[1] 15144    12
......
FL-CM-12samp-intDNA.diff2-1.txt
cat  FL-int-DNA-CM-EM-samp-donor-sortedHIV | grep -w EM |  cut -f 5 > temp-samp-sortedHIV 
cat  FL-int-DNA-CM-EM-samp-donor-sortedHIV | grep -w EM > FL-int-DNA-CM-EM-samp-donor-sortedHIV-EM
>  dim(y)
[1] 14065    12
FL-EM-12samp-intDNA.diff2-1.txt


FL-genecount-EM-12samp-intDNA.txt
bash ./script-preRank-genes FL-CM-EM-24samp-intDNA.diff2-1.txt |  grep -wv logFC | sed 's/\.[0-9]*	/	/' > FL-CM-EM-24samp-intDNA.rnk
"../antiIL10 monkey/dir-IL10-covid19/dir-belg-scRNAseq/ugent.covid-master/run/scrnaseq-metaannot-combine" FL-CM-EM-24samp-intDNA.rnk GRCh38-geneID-name out
paste FL-CM-EM-24samp-intDNA.rnk  out | awk 'BEGIN {FS = "\t"; OFS = "\t"} {print $4, $2}' | grep -v "notApplicable" > FL-CM-EM-24samp-intDNA.name.rnk

FL-CM-EM-24samp-intDNA.name.rnk
FL-CM-12samp-intDNA.name.rnk
FL-EM-12samp-intDNA.name.rnk

FL-EM-12samp-intDNA.transpose.txt
FL-EM-12samp-intDNA.top50.pos.cor.genes
FL-EM-12samp-intDNA.top50.neg.cor.genes
FL-CM-12samp-intDNA.top50.pos.cor.genes

FL-CM-12samp-intDNA.name.rnk
FL-CM-EM-24samp-intDNA.name.rnk
FL-EM-12samp-intDNA.name.rnk
FL-CM-8samps-EM-9samps-tilda.name.rnk
FL-CM-8samps-tilda.name.rnk
FL-EM-9samps-tilda.name.rnk
star-CPM.tcm.GLM.hiv.diff2-1.name.rnk
star-CPM.tcm.tem.GLM.hiv.name.rnk
star-Tem-5samp.infect.name.rnk

bash -x script-pathway-pValue-condition-table
cat temp-gsea_report.xls| awk 'BEGIN {FS = "\t"; OFS = "\t"} $7 < 0.05 && $8 < 0.25 ' | cut -f 1 | sort | uniq > temp-sig-pathways
rm temp-sig-paths-*
bash  script-pathway-pValue-condition-table-overlap
bash -x script-pathway-pValue-condition-table-step2
paste temp-sig-paths-FL-CM-12samp-intDNA.h.all.v7.1.GseaPreranked.1614066212142 temp-sig-paths-FL-CM-EM-24samp-intDNA.h.all.v7.1.GseaPreranked.1614066224282 temp-sig-paths-FL-EM-12samp-intDNA.h.all.v7.1.GseaPreranked.1614066235529 > temp.out
bash script-pathway-pValue-condition-table-step3 > FL-intDNA.h.all.txt

bash  script-get-module-common-genes out.tem-p0.05-all-paths.net.1.I20 4
bash script-get-module-common-genes-enrich-api out.tem-p0.05-all-paths.net.1.I20 4
###string-api-enrich
bash script-process-string-enrich > temp.txt
###process string enrich results

bash tem-script-path-scores
cp -i temps script-signed-p-value-discrete
script-signed-p-value-discrete-2
cut -f 1 *name.rnk | sort | uniq | awk '{print toupper($1)}' >  genes-20656.txt
### 9 rnk files, 17161 gene names
bash  temp-leg-genes-pathway-dir
POSITIVE_REGULATION_OF_T_CELL_ACTIVATION.tem.rnk.values
REGULATION_OF_INFLAMMATORY_RESPONSE.CM.rnk

dir-FL-em-up-up linyongmao$ bash ../script-process-string-enrich-all-go > temp.txt
# top 40 EM-up-up GO terms
vi temp-em-up-go-terms ###cp -i  temp-em-up-go-terms FL-em-up-up-1goterm-1clust
bash script-go2genes > out
bash ../script-generate-chea-target-file /Users/linyongmao/Documents/dir-gene-set-database/CHEA-tf.gmt
ln ../genes-20656.txt ./
bash ../script-TF-targets-enrich > temp-gogenes-TF.net
bash "../../antiIL10 monkey/dir-TF-db/script-hyperG-test-2-R"  temp-gogenes-TF.net > temp-r-input
Rscript temp-r-input > temp-r-res
cat temp-r-res | awk '{print $2}' > temp-p
vi temp-p
paste temp-gogenes-TF.net temp-p > temp-net-P
paste temp-net-P temp-q > temp-net-P-q
cat temp-net-P-q | awk 'BEGIN {FS = "\t"; OFS = "\t"} $8 < 0.05' > FL-em-up-up-top40gogenes-chea-p-q
FL-em-up-up-allgogenes-chea-p-q
bash  script-FL-em-up-up-goterm-TF.table 
bash script-path-multi-TF > temp-path-tfs
bash script-path-genes > temp-path-genes
vi  temp-path-genes-tf
bash ../script-process-string-enrich-all-go-log > temp.txt
bash script-go2genes-sel-Pvalue-per-go | grep "^pvalueperGO" | cut -f 2-3 > temp-Pvalue-per-go
"../../antiIL10 monkey/dir-IL10-covid19/dir-belg-scRNAseq/ugent.covid-master/run/scrnaseq-metaannot-combine" temp-Pvalue-per-go temp-path-genes-tf out
paste temp-Pvalue-per-go out > FL-em-up-up-1goterm-1clust-p-genes-TF.txt
FL-em-down-down-1goterm-1clust-p-genes-TF.txt

FL-cm-down-down-topgogenes-chea-p-q
x <- read.delim("dir-FL-cm-down-down/temp-em-cm-tf-func")
for( i in 1:dim(x)[1]) {
em <- x[i,2];
cm <- x[i,3];
data <- c(em, 36 - em, cm, 16 - cm);
tab <- t(matrix(data, nrow=2,ncol=2))
test <-fisher.test(tab)
res <- c(x[i,1], test$p.value, test$estimate);
cat(res);
}

###bash ../script-process-string-enrich-all-go > temp.2.txt
dir-FL-em-down-down linyongmao$ bash ../script-process-string-enrich-all-go > temp.txt
bash tem-script-go2genes > out
......
###131 temp-go-each-module
### bash ../dir-FL-cm-down-down/script-process-string-enrich-top20 > temp.txt
cat temp.txt | cut -f 9 | sort | uniq -c | sort -n  | awk '$1 > 3' > temp-dup-4
vi temp-dup-4
###"../../antiIL10 monkey/dir-IL10-covid19/dir-belg-scRNAseq/ugent.covid-master/run/scrnaseq-metaannot-combine" temp-dup-4 temp-go-each-module out
###paste temp-dup-4 out | cut -f 1-4 | grep -w notApplicable | cut -f 1-2

dir-FL-em-up-up linyongmao$ cat temp-dir-orig | while read d; do cat "$dir"/"$d"/"$d".rpt; done | grep set_min | uniq -c
   8 param	set_min	5
   8 param	set_max	500
bash  script-gsea-star-hiv FL-EM-12samp-intDNA.name.rnk


temp-4-interest-paths
bash -x script-pathway-pValue-condition-table-sel-a-path-LEG GSE17974_IL4_AND_ANTI_IL12_VS_UNTREATED_24H_ACT_CD4_TCELL_DN
cat temp-dir
cat temp-gsea_report.xls | grep -w Yes|cut -f 2 |sort | uniq -d > temp.genes


vi temp-star-genes
bash temp-scrip > temp.txt
cat temp2 | cut -f 4,7,19,20,25,27 |head -2
cat temp2 | cut -f 4,7,19,20,25,27 | sort -t '	' +5 -6n | head

###MSD 
Hiv-infect.txt
20200903_STAR_MSD.samp-info.txt
20200903_STAR_MSD.txt
grep -w IL-10 20200903_STAR_MSD.txt  | grep -i star | cut -f 2-4 > temp-il10
"../antiIL10 monkey/dir-IL10-covid19/dir-belg-scRNAseq/ugent.covid-master/run/scrnaseq-metaannot-combine"  temp-il10 20200903_STAR_MSD.samp-info.txt out
paste  temp-il10  out | cut -f 1-11 > temp-il10.txt
cat temp-il10.txt | grep  "Prior *ATI" | sort | uniq > temp.2.txt

cat 20200903_STAR_MSD.txt| cut -f 2-4| grep ^STAR > temp-1
"../antiIL10 monkey/dir-IL10-covid19/dir-belg-scRNAseq/ugent.covid-master/run/scrnaseq-metaannot-combine" temp-1 20200903_STAR_MSD.samp-info-coded.a1-a2.txt out
paste  temp-1  out > temp2.txt
cat temp2.txt | cut -f 2,3,5,6 | awk 'BEGIN {FS = "\t"; OFS = "\t"} {print $1, $3 "_" $4, $2, $3, $4 }' > temp3.txt
bash script-order-MSD   temp3.txt > temp4.txt
bash script-MSD-table-1 temp4.txt | sort | uniq > temp5.txt
head -1 temp5.txt | awk 'BEGIN {FS = "\t"; OFS = "\t"} {for(i = 1; i <= NF; i++) print  $i}'   | sort | uniq -d | wc -l ###should be zero
vi temp5.txt ####s /	NaN/	NA/g
cp -i temp5.txt  20200903_STAR_MSD.32cytoALLsamps.matrix.txt
> x <- read.delim("temp5.txt", row.names=1)
> a = log10(x)
b = a
> for(i in 1:dim(b)[1])
{
 a[i, ] <- (a[i, ] - mean(as.numeric(b[i,]), na.rm=T)) / var(as.numeric(b[i,]), na.rm=T)^(1/2) 
}
> ann <- read.delim("temp-IL-10.cyto.txt", header=F)
> rownames(ann) = c("s", "n", "v","donnor", "time", "t")
> ha <- HeatmapAnnotation(donor = t(ann[4,]), time = t(ann[5,]) )
> Heatmap(matrix = mat, name = "Z score",  column_names_side = "top",  row_names_gp = gpar(fontsize = 8), height = unit(9, "cm"), width= unit(20, "cm"), clustering_distance_rows = "pearson", top_annotation = ha, column_order=1:52)
####extract speific donor & cyto data matrix
head -1 20200903_STAR_MSD.32cytoALLsamps.matrix.txt | awk 'BEGIN {FS = "\t"; OFS = "\t"} {for(i = 1; i <= NF; i++) print i, $i}' | grep  STAR0009

####paired wilcox test to find cyto diff between two conditions
sort temp1 | uniq -d > temp-star-28910 #donors have both p2 & a2 cyto readouts
cat temp-star-28910 | while read star; do grep -w $star  temp4.txt | sort | uniq; done  > temp-4donors-cyto
cat  temp-4donors-cyto | grep -w p2 > temp-4donors-p2
cat  temp-4donors-cyto | grep -w a2 > temp-4donors-a2
###cyto name identical
paste temp-4donors-p2 temp-4donors-a2 | awk 'BEGIN {FS = "\t"; OFS = "\t"} $1 !=  $7' | wc -l
###donor ID identical
paste temp-4donors-p2 temp-4donors-a2 | awk 'BEGIN {FS = "\t"; OFS = "\t"} $4 !=  $10' | wc -l
####128 p2	a2
paste temp-4donors-p2 temp-4donors-a2 |cut -f 5,11 | uniq -c
paste temp-4donors-p2 temp-4donors-a2 |cut -f 1,3,9 | sort | grep -wv NaN > results
bash script-wilcox-test-2-R results > temp-r-input
Rscript temp-r-input > temp-r-result
cat temp-r-result | awk 'NF > 2'  | awk 'BEGIN {OFS = "\t"} {print $1, $2, $3}'  | sed 's/"//g' 
##ls -lh temp-p2-a2-p-values*  temp-a2*

# make heatmap or Excel plot of 1 cytokine, many donors across time points
#script-1cyto-multi-time-points
cyt="TGF-b1"
cat  temp4.txt | grep -w "$cyt" | sort | uniq | grep -w r1 | awk 'BEGIN {FS = "\t"; OFS = "\t"} {print $4, $5, $3}' > temp1
##STAR0002      r1      18.03312259
cat  temp4.txt | grep -w "$cyt" | sort | uniq | grep -w a2 | awk 'BEGIN {FS = "\t"; OFS = "\t"} {print $4, $5, $3}' > temp2
cat  temp4.txt | grep -w "$cyt" | sort | uniq | grep -w p2 | awk 'BEGIN {FS = "\t"; OFS = "\t"} {print $4, $5, $3}' > temp3
###make sure temp1 has all donors needed for the plot
 "../antiIL10 monkey/dir-IL10-covid19/dir-belg-scRNAseq/ugent.covid-master/run/scrnaseq-metaannot-combine" temp1 temp2 out
paste temp1 out  | cut -f 1-6 > temp1-out
mv temp1-out temp1
"../antiIL10 monkey/dir-IL10-covid19/dir-belg-scRNAseq/ugent.covid-master/run/scrnaseq-metaannot-combine" temp1 temp3 out
paste temp1 out | cut -f 1-9 > temp1-out
echo | awk 'BEGIN {FS = "\t"; OFS = "\t"}
 {
  print "'$cyt'", "p2",	"a2",	"r1";
 }' > temp.txt

cat temp1-out | awk 'BEGIN {FS = "\t"; OFS = "\t"}
 {
  print $1, $9, $6, $3;
 }' >> temp.txt

cat temp.txt | sed 's/notApplicable//g' > temp-NA
mv temp-NA temp.txt
cat temp.txt

script-cyto-tcm-corr-2-R
paste temp-p1-tcm-out temp-p1-tem-out temp-p1-total-out temp-p2-tcm-out temp-p2-tem-out temp-p2-total-out > temp.txt
cat temp.txt | awk 'BEGIN {FS = "\t"; OFS = "\t"} {for(i = 4; i <= NF; i = i+5) if($i < 0.1) print $0}' > temp2.txt
###heatmap (cyto_at_p2_timePoint + hiv) x donors
cat  20200903_STAR_MSD.32cytoALLsamps.a1ORa2.matrix.txt  | awk 'NR == 1' | awk 'BEGIN {FS = "\t"; OFS = "\t"} {for(i = 1; i <= NF; i++) print i, $i}'  | grep _p2 |  cut -f 1  | awk 'BEGIN {FS = "\t"; OFS = ""; ORS = ""} {print $1 ","}'
cat  20200903_STAR_MSD.32cytoALLsamps.a1ORa2.matrix.txt  | cut -f 1,3,17,21,30,35,41 | awk '$1 ~ /A_sample/ || $1 ~ /TGF-/' > temp-1
"/Users/linyongmao/Documents/antiIL10 monkey/dir-IL10-covid19/table-transpose" temp-1 temp-cyto-p2-trans
temp-cyto-p2-trans
#A_sample	TGF-B2_p2	TGF-B3_p2	TGF-b1_p2
#STAR0002	16.02081172	0.63647732	4777.108435
temp-tem-from-paper
temp-tem-hiv-tgfb-p1_p2_trans

###glmfit cyto ~ RNA-seq
cat gene-count-Tcm.6samp.txt|head -1 | awk 'BEGIN {FS = "\t"; OFS = "\t"} {for(i = 1; i <= NF; i++) print  $i}'  > temp-rnaseq-samp
"../antiIL10 monkey/dir-IL10-covid19/dir-belg-scRNAseq/ugent.covid-master/run/scrnaseq-metaannot-combine" temp-rnaseq-samp temp out ####temp: samp_57	0.458996743	0.023573828	STAR005	57	CD4+ Tcm ::sampleID - starID
paste temp-rnaseq-samp out  |  awk 'BEGIN {FS = "\t"; OFS = "\t"} {print $5, $1, $7}' | grep -v notApplicable | sed 's/0/00/' > temp-rnaseq-samp-starID
vi temp-rnaseq-samp-starID
"../antiIL10 monkey/dir-IL10-covid19/dir-belg-scRNAseq/ugent.covid-master/run/scrnaseq-metaannot-combine" temp-rnaseq-samp-starID temp-cyto-p2-trans out
paste temp-rnaseq-samp-starID out | grep -vw notApplicable | cut -f 4,5 > temp-cyto-p2-trans-with-rna-seq
vi temp-cyto-p2-trans-with-rna-seq
cat gene-count-Tcm.6samp.txt|cut -f 1,3,5,6,7 > temp-gene-count-tcm-4samp.txt
Rscript temp-script-diff2-1-TEMrna-seq-cytokine.glm.R
###[1] 6456-genes-kept    4
bash -x script-diff-2-rnk
bash script-gsea-star-hiv star-CPM.tcm.GLM.Fractalkine.diff2-1.name.rnk

temp-cyto-p2-trans-with-rna-seq
cp -i temp-cyto-p2-trans-with-rna-seq cyto-p2-trans-with-rna-seq-tem

cat   dir-pearson-cor-pathways/gene-count-Tem-7samp.txt |awk 'BEGIN {FS = "\t"; OFS = "\t"} {print $1, $6, $7, $4, $3}' > temp-gene-count-tem-4samp-star568-10.txt
> keep <-rowSums(cpm(y)>0) >= 3
> y<-y[keep,]
> dim(y)
[1] 8510    4
star-CPM.tem.GLM.IL-15.diff2-1.txt
script-diff2-1-TEMrna-seq-cytokine.glm.R
script-diff-2-rnk

bash script-cyto-hivPOS-pathway-p-value >> result.xls
bash script-cyto-hivNEG-pathway-p-value >> result.xls

###MSD ~ TF
"/Users/linyongmao/Documents/antiIL10 monkey/dir-IL10-covid19/table-transpose" 20200903_STAR_MSD.32cytoALLsamps.matrix.txt temp-1
head -1 temp-1 > temp-2
cat temp-1 | awk '$1 ~ /p2/' >> temp-2
"/Users/linyongmao/Documents/antiIL10 monkey/dir-IL10-covid19/table-transpose" temp-2 temp-3
cut -f 1,3,4,5,7 temp-3 | grep -wv NA > temp-5 ####p2 is day(s) prior to ATI, 4 star samples with RNA-seq data, rm 'NA' cytokine
cat dir-map-stat/gene-count-Tem-RA-Tscm.7-4.txt |cut -f 1,6,7,4,3 > temp-tem-gene-count
> keep <-rowSums(cpm(y)>0) >= 3
> y<-y[keep,]
> dim(y)
[1] 8510    4
write.table(cpm(y), "cpm-tem-4samp-cyto.txt", sep = "\t", quote=F)
cat temp-5 | awk 'BEGIN {FS = "\t"; OFS = "\t"} {print $1, $5, $4, $2, $3}' > cyto-plasma-p2-4donors.txt
###donor matches in MSD and gene expression

cat temp-tem-infect
#STAR0002_p2	518
cat temp-tem-infect-il15
#STAR0002_p2	518	2.147783982
cat   dir-pearson-cor-pathways/gene-count-Tem-7samp.txt | awk 'BEGIN {FS = "\t"; OFS = "\t"} {print $1,"NA", $6, $7, $2, $4, "NA", $3, $5, $8}' | head
gene	NA	samp_49	samp_51	samp_17	samp_27	NA	samp_22	samp_36	samp_7
ENSG00000000003	NA	0	0	0	0	NA	7	0	0
ENSG00000000005	NA	0	0	0	0	NA	0	0	0
ENSG00000000419	NA	0	758	299	379	NA	452	4	0

gene	STAR0002	STAR0005	STAR0006	STAR0007	STAR0008	STAR0009	STAR0010	STAR0011	STAR0012

$ cat  temp-samp-star  | cut -f 1,4
samp_49	STAR005
samp_51	STAR006
samp_17	STAR007
samp_27	STAR008
samp_22	STAR010
samp_36	STAR011
samp_7	STAR012

cat   dir-pearson-cor-pathways/gene-count-Tem-7samp.txt | awk 'BEGIN {FS = "\t"; OFS = "\t"} {print $1,"NA", $6, $7, $2, $4, "NA", $3, $5, $8}' > temp-1
"/Users/linyongmao/Documents/antiIL10 monkey/dir-IL10-covid19/table-transpose" temp-tem-infect-il15 temp-tem-infect-il15-trans
cat temp-tem-infect-il15-trans temp-1 > temp.txt
vi temp.txt
cp -i temp-tem-infect-il15-trans  star-tem-infect-il15-trans

temp-tem-genes-FL.dna.tilda.txt
temp-fl-tem-top50genes
temp-fl-tem-top50genes-in-star
temp-fl-tcm-inflam-16genes
cat FL-genecount-EM-12samp-intDNA.txt | cut -f 1 | awk 'BEGIN {FS = "\t"; OFS = "\t"} {print $1, $1}'|sed 's/"//' | sed 's/"//' |sed 's/\.[0-9]*//' > temp-id-id2
chrY-genes.name.id.2
temp-fl-tcm-ifn-3genes

cat temp-gsea_report.xls| awk 'BEGIN {FS = "\t"; OFS = "\t"}  $6 < -0.05 &&  $7 < 0.05 && $8 < 0.25 '  |  cut -f 1,4,6-8 > temp.star-CPM.tcm.txt
cat temp-gsea_report.xls| cut -f 1,4,6-8 > temp.FL-CM-12samp-intDNA.txt
cat temp-gsea_report.xls| cut -f 1,4,6-8 > temp.FL-CM-8samps-tilda.txt
paste  temp.star-CPM.tcm.txt  temp.FL-CM-8samps-tilda.sub.txt temp.FL-CM-12samp-intDNA.sub.txt > temp.txt
cat star-Tem-5samp.infect.name.rnk | awk '$2 > -log(0.01)/log(10)' | cut -f 1 | sort | uniq > temp-tem-degs
bash  script-TF-targets-enrich  > temp-net-1
cat temp-lead-genes.tem-deg.xls chea-TF-regulation_of_macromolecule_metabolic_process.targets.xls | sort | uniq -d > temp-reg.genes

cat  dir-FL-em-up-up/FL-em-up-up-gogenes-TF.net-P-q |awk 'BEGIN {FS = "\t"; OFS = "\t"} $8 < 0.05' | cut -f  2| sort | uniq -c  |sort -nr | head -50
cat  dir-FL-em-up-up/FL-em-up-up-gogenes-TF.net-P-q |awk 'BEGIN {FS = "\t"; OFS = "\t"} $8 < 0.05' > temp-1
temp-2 ##33 gene sig. from TEM, select-go.xlsx
cat temp-2 | while read ll; do grep "^$ll	" temp-1; done > temp-3
wc -l temp-3
###     672 temp-3
cut -f 2 temp-3 | sort |uniq -c | wc -l
##     135 TFs regulate top 33 gene sig (enrich p value)
cut -f 2 temp-3 | sort |uniq -c | sort -n  | awk '$1 > 8 {print $2}' > temp-4
wc -l temp-4
###      23 temp-4 top23 TFSs regulating 33-gene-sig; each TF regulating > 8 gene-sig
cat temp-4 | while read ll; do grep "	$ll	" temp-3; done > temp-5
wc -l temp-5
###     247 temp-5, 23TFs X 33 (maybe < 33)  gene-sig; 
cp -i dir-FL-em-up-up/script-FL-em-up-up-goterm-TF.table script-1
bash script-1
vi FL-em-up-up-topgoterm-freqTF.table.txt ###only include go terms with > 2 regulating TFs
cat dir-is-integration-site/IS-TF-reg-p-q | awk 'BEGIN {FS = "\t"; OFS = "\t"} $8 < 0.05' | cut -f 2 | sort | uniq > temp-IS-TF-fdr0d05 ##16 TFs
"../antiIL10 monkey/dir-IL10-covid19/dir-belg-scRNAseq/ugent.covid-master/run/scrnaseq-metaannot-combine" temp-IS-TF-fdr0d05 temp-rank out ###GATA1	44(# of gene sig)	3(rank)
cat temp-2 | while read ll; do grep "^$ll	" /Users/linyongmao/Documents/dir-gene-set-database/CHEA-tf.gmt; done > temp-3 ###specific TF .gmt
bash script-TF-targets-enrich-geneList
bash script-TF-targets-enrich-geneList | cut -f 2,3 > temp-net
cp -i temp-net dir-is-integration-site/IS-TF-targetGenes.txt
dir-is-integration-site/IS-TF-targetGenes.net.propert.txt
cat dir-is-integration-site/IS-TF-targetGenes.txt | awk 'BEGIN {FS = "\t"; OFS = "\t"} {print $2, $1, "1"}' > temp-net ###TF-targetGene 0/1 table for heatmap
bash script-1 temp-net ###TF-targetGene 0/1 table for heatmap

./geneSeqSelect.use-string  dir-is-integration-site/temp.fasta temp-gene-ID out
cat temp-gene-ID
3.1|STAR09_TCM_03|Laurens_Lambrechts|PBMC
####################################HLA associated mutations in hiv genes 
grep ">" viroverse-2021-06-29-star09.fasta | sed 's/>//' > temp.geneID
../geneSeqSelect.use-string viroverse-2021-06-29-star09.fasta temp.geneID out
vi out #rm trailing ---*$
##web service multiple align of raw sequences
https://www.hiv.lanl.gov/cgi-bin/GENE_CUTTER/gc.cgi
###sel IDs with full coverage of gag gene
cat temp | grep '* ' | awk '$4 > 490' | awk '{print $1}'> temp-ID-2 
#cat temp | grep " 503" | awk '{print $1}'> temp-ID-2
../geneSeqSelect.use-string out temp-ID-2 out2
wc -l out2
submit out2 to GENE_CUTTER again for the alignment
sel gag, insert ref into results
#rm gag seq with nonsense (premature stop codon), frame shift 
grep -v '*' temp-1 | grep -v '#' | awk '{print $1}' | sort  |uniq -c | awk '$1 > 5'  | grep -vw HXB2 | awk '{print $2}'  > temp-ID-3
# STAR09, all seq, gag full-length seq, rm nonsense/frame shift mutation
     137 temp.geneID
      73 temp-ID-2
      28 temp-ID-3
../geneSeqSelect.use-string out temp-ID-3 out3
##start with HXB2
vi temp-aln ###multiple aln file
cat temp-aln | awk '{print $3}' > temp-aln-2
bash -x script-paste-aln-blocks
vi temp-aln-3
cat temp-aln-3 | sed 's/       //g' | sed 's/\(.\)/\1  /g' > temp-aln-4.txt
bash script-countAAfreq-in-each-column > temp-aln-5.txt
cp -i temp-aln-5.txt star09-gag-aln-AAfreq.txt
cat  HLA-assoc-mutation-plusOne2009.txt  | grep -wi gag | grep -iw Direct | awk '$8 < 0.05'  > temp-gag-mut  ###101 mutations
cat  HLA-assoc-mutation-plusOne2009.polGeneOnly.txt | grep -iw Direct | awk '$8 < 0.05'  > temp-gag-mut  ###for Pol gene only which contains 3 proteins PR, RT, INT
cat hla.star04.txt
#star04 A02 A32 B15 B44 C03 C05
bash script-sel-hla-asso-mut  star09.hla.txt > temp-gag-mut-star09-hla
bash script-find-mutation temp-gag-mut-star09-hla temp-aln-5.txt > out
bash script-find-mutation-2 > out.txt
###specific for pol gene because it has 3 proteins
bash script-find-mutation-3 > out.txt

bash  script-hla-associ-mut-pipeline1 star09 ###start following vi temp-aln ###multiple aln file

###FLorida cytokine ~ RNA-seq , FL
FL-donors-with-RNAseq-cytokine ##15 samples
cat ./Florida-cohort-RT/raw.modify.CM-EM-ordered.txt | cut -f 1,18-19,21-100 > temp-em-genecount-15samples ###rm HT06(ST114) sample, no cytokine
 rawCount <- read.delim("temp-em-genecount-15samples", header = T, row.names = 1)
 dim(rawCount)
###[1] 60155    15
 group <- factor(rep(1, 15))
 y <- DGEList(counts=rawCount,group=group)
 y <- calcNormFactors(y)
 keep <-rowSums(cpm(y)>=1) > 15/4
 y<-y[keep,]
 dim(y)
###[1] 14828    15
 d <- cpm(y)
 write.table(d, "temp-2-CPM.txt", sep="\t")
a = log10(d+1)
b = a
for(i in 1:dim(b)[1])
{
 a[i, ] <- (a[i, ] - mean(as.numeric(b[i,]), na.rm=T)) / var(as.numeric(b[i,]), na.rm = T)^(1/2) 
}
write.table(a,file="temp.em.log10.z.txt", sep = "\t", quote = F)
vi temp.em.log10.z.txt ##edit header line, add "geneID" field
cat temp.em.log10.z.txt | cut -f 1 | awk 'BEGIN {FS = "\t"; OFS = "\t"} {print $1, $1}' | sed 's/\.[0-9]*//' > temp-1
"../antiIL10 monkey/dir-IL10-covid19/dir-belg-scRNAseq/ugent.covid-master/run/scrnaseq-metaannot-combine" temp-1  GRCh38-geneID-name out
paste temp-1 out | grep -vw notApplicable |cut -f 2-4 > temp-2 ###ENSG00000000003.12	ENSG00000000003	TSPAN6 ; em.log10.z genes with Names; if no Names, discarded
wc -l temp-2
###14764 temp-2
"../antiIL10 monkey/dir-IL10-covid19/dir-belg-scRNAseq/ugent.covid-master/run/scrnaseq-metaannot-combine" temp-2 temp.em.log10.z.txt out
cat out | awk '{print NF}' | uniq -c
###14764 16
paste temp-2 out |cut -f 3,5-100 > temp.em.log10.z.geneName.txt ###ENSG00000000003.12	ENSG00000000003	TSPAN6	ENSG00000000003.12	1.32183982639182	-0.557593780014383	1.46777061946307 ; before cut
head -1 temp.em.log10.z.txt > temp-3
cat temp.em.log10.z.geneName.txt >> temp-3
mv temp-3 temp.em.log10.z.geneName.txt
x <- read.delim("temp.em.log10.z.geneName.txt", header = T)
summary(x)
dim(x)
bash temp-script-generate-chea-target-file  ~/Documents/dir-gene-set-database/FL-em-intDNA-tilda-gene-sig.up.gmt
bash temp-script-generate-chea-target-file  ~/Documents/dir-gene-set-database/FL-em-intDNA-tilda-sig-50recur-genes.up.gmt
wc -l temp-lead-genes*
vi script-pathway-exprAvg-ln-hallmark-2 
bash script-pathway-exprAvg-ln-hallmark-2 > temp-1301
cat temp-1301 | awk 'NF > 10' | sed 's/temp-lead-genes.//' | sed 's/.xls//' > temp-path-avg-exp
vi temp-path-avg-exp ###add first field header
cut -f 2-17 temp-path-avg-exp > temp-path-avg-exp-2
"../antiIL10 monkey/dir-IL10-covid19/dir-belg-scRNAseq/ugent.covid-master/run/scrnaseq-metaannot-combine" temp-FL-donon-sample-info-EM FL-cytokine.txt out
paste temp-FL-donon-sample-info-EM out | cut -f 2,5-100 |  grep -vw notApplicable > temp-1 ###ST112	HT02	EM	ST112	174.7200969	451.7609069 ; before cut
"/Users/linyongmao/Documents/antiIL10 monkey/dir-IL10-covid19/table-transpose" temp-1 temp.plasma.cytokine.txt
head -2 temp.plasma.cytokine.txt > temp
head -2 temp-path-avg-exp-2 >> temp
cat temp | cut -f 2-200 | sort | uniq -c ###check cytokine sample order & RNA-seq sample order

bash script-FL-em-up-up-goterm-TF.cyto.table
cat temp-go-tf-table.txt | cut -f 1,4,6,9,11,13,14 > temp-go-tf-table.2.txt ##only retail cytok with significant corr.
annot <- read.delim("temp-go-tf-table.2.txt", row.names=1)
> col_fun = colorRamp2(c(-1, 0, 1), c("green", "white", "red"))
> ca <- rowAnnotation(IFNg = annot$IFNg, IL15 = annot$IL.15, IL6=annot$IL.6,  SDF1a=annot$SDF.1a , TGFb3=annot$TGF.b3, TNFa =annot$TNFa, col = list(IFNg = col_fun, IL15 = col_fun, IL6 = col_fun, SDF1a = col_fun, TGFb3 = col_fun, TNFa = col_fun))
> Heatmap(matrix = x, name = "TF reg",  column_names_side = "top",  row_names_gp = gpar(fontsize = 7), height = unit(10, "cm"), width= unit(4, "cm"), right_annotation=ca)

> x <-read.delim("FL-tem-go-8TFs-NANOG-YAP1.table.1.txt", row.names=1)
> clust <- read.delim("FL-tem-go-8TFs-NANOG-YAP1.clust-info.txt", header = T, row.names=1) ### row name (gene sig name) order same as data-matrix of main heatmap
>  ca <- rowAnnotation(cluster=clust$cluster)
> colum.split <- c(rep("1.TF", 8),rep("2.cyto", 6))
> col_fun = colorRamp2(c(-1, 0, 1), c("blue", "grey", "red"))
> Heatmap(matrix = x, name = "TF/cytokine",  column_names_side = "top",  row_names_gp = gpar(fontsize = 7), height = unit(10, "cm"), width= unit(4, "cm"), row_split= clust$cluster, column_split=colum.split, right_annotation=ca, col = col_fun, )
> Heatmap(matrix = x, name = "TF/cytokine",  column_names_side = "top",  row_names_gp = gpar(fontsize = 7),  row_split= clust$cluster, column_split=colum.split, right_annotation=ca, col = col_fun, ) ##not setting height and width; first make quartz large, then adjust quartz size

:s/[1-9]STAR /STAR /g
:s/\(STAR 9\)\(T[CE]M\)\([0-9][0-9]*\)/^M\1^I\2^I\3/g
:2, 10 s/\([0-9][0-9]*\)\([-+]\)\(.*\)Same\([0-9][0-9]*\)/\1^I\2^I\3^ISame^I\4/
:2, 10 s/\([0-9][0-9]*\)\([-+]\)\(.*\)Opposite\([0-9][0-9]*\)/\1^I\2^I\3^IOpposite^I\4/

:11, 13 s/[0-9][0-9]STAR /STAR /g
:11, 13 s/\(STAR 9\)\(T[CE]M\)\([0-9][0-9]*\)/^M\1^I\2^I\3/g
:12, 100 s/\([0-9][0-9]*\)\([-+]\)\(.*\)Same\([0-9][0-9]*\)/\1^I\2^I\3^ISame^I\4/
:12, 100 s/\([0-9][0-9]*\)\([-+]\)\(.*\)Opposite\([0-9][0-9]*\)/\1^I\2^I\3^IOpposite^I\4/

:105, 108 s/[0-9][0-9][0-9]STAR /STAR /g
:105, 108 s/\(STAR [0-9][0-9]*\)\(T[CE]M\)\([XY0-9][0-9]*\)/^M\1^I\2^I\3/g
:106, $ s/\([0-9][0-9]*\)\([-+]\)\(.*\)Same\([0-9][0-9]*\)/\1^I\2^I\3^ISame^I\4/
:106, $ s/\([0-9][0-9]*\)\([-+]\)\(.*\)Opposite\([0-9][0-9]*\)/\1^I\2^I\3^IOpposite^I\4/
3114333246      -       ZBTB20 ; special treatment because no # of detected times
cat star-3donors-IS-paper-table.2 | awk 'BEGIN {FS = "\t"; OFS = "\t"} NF == 3'  | grep NANA | wc -l
      32
cat star-3donors-IS-paper-table.2 | awk 'BEGIN {FS = "\t"; OFS = "\t"} NF == 7'   | wc -l
     248
cat dir-is-integration-site/IS-summary-by-gene.txt | awk 'BEGIN {FS = "\t"; OFS = "\t"} $5 > 3' | cut -f 3 > temp-1
vi temp-1 ###21 genes with in vivo >3 subjects; same as excel file
cat star-3donors-IS-paper-table.2 | awk 'BEGIN {FS = "\t"; OFS = "\t"} NF == 7'   | cut -f 5  | sort | uniq -d > temp-stat-is-genes ##24 genes
cat star-3donors-IS-paper-table.2 | awk 'BEGIN {FS = "\t"; OFS = "\t"} NF == 7'   | awk 'BEGIN {FS = "\t"; OFS = "\t"} $7 > 1' | cut -f 5 >> temp-stat-is-genes
sort temp-stat-is-genes | uniq > temp-stat-is-genes-2 ##45 genes with 'No. detected' > 1
mv -i temp-stat-is-genes star-is-genes
mv -i temp-stat-is-genes-2 star-is-genes-2
cp -i star-is-genes-2 chea-TF-STAR-IS.targets.xls
    298 temp-lead-genes.IS2.xls ###IS in >=2 subjects using public database
      63 temp-lead-genes.IS3.xls
      21 temp-lead-genes.IS4.xls
bash script-TF-targets-enrich > temp-gogenes-TF.net
bash "../antiIL10 monkey/dir-TF-db/script-hyperG-test-2-R"  temp-gogenes-TF.net > temp-r-input
Rscript temp-r-input > temp-r-res
cat temp-r-res | awk '{print $2}' > temp-p
vi temp-p
paste temp-gogenes-TF.net temp-p > temp-net-P
cp -i temp-net-P star-is-genes-2-publicIS-overlap-net-p.txt
star-is-genes-2-TF-overlap-p-q 


module avail | grep -i star
module avail  STAR
module load STAR
# load modules
module load gcc/6.3.0
module load openmpi/2.0.1
module load python/3.7.0
module load samtools/1.9
module load STAR/2.7.0e

wget ftp://ftp.ensembl.org/pub/release-100/fasta/homo_sapiens/dna/Homo_sapiens.GRCh38.dna.primary_assembly.fa.gz
wget ftp://ftp.ensembl.org/pub/release-100/gtf/homo_sapiens/Homo_sapiens.GRCh38.100.gtf.gz
###genome indexing
STAR   --runMode genomeGenerate   --genomeDir dir-genome  --genomeFastaFiles dir-genome/Homo_sapiens.GRCh38.dna.primary_assembly.fa  --genomeSAsparseD 2 --runThreadN 2 --sjdbGTFfile dir-genome/Homo_sapiens.GRCh38.100.gtf     --sjdbOverhang 99  ##99 = readLength - 1
# number of nodes and processors, memory required
#SBATCH --nodes=1
#SBATCH --cpus-per-task=8
#SBATCH --mem=32gb
# time requirements
#SBATCH --time=12:00:00

java -Xmx1g \
		-jar $bin/Trimmomatic-0.39/trimmomatic-0.39.jar PE \
		-threads $maxProc \
		-phred33 \
		-trimlog ${sample}_trim.log \
		${sample}_1.fq.gz \
		${sample}_2.fq.gz \
		${sample}_1.trimmed.fq.gz \
		${sample}_1.unpaired.fq.gz \
		${sample}_2.trimmed.fq.gz \
		${sample}_2.unpaired.fq.gz \
		ILLUMINACLIP:$adapterFile:2:30:10:8:TRUE \
		LEADING:3 \
		TRAILING:3 \
		SLIDINGWINDOW:4:15 \
		MINLEN:36 &> ${sample}_trim.err
adapterFile="Trimmomatic-0.39/adapters/TruSeq3-PE-2.fa"
java -Xmx1g -jar Trimmomatic-0.39/trimmomatic-0.39.jar  PE  -threads 2    -phred33   -trimlog temp-trimmom.log /scratch/users/lxm416/star/tempDir12-2/temp-12_1.fq.gz /scratch/users/lxm416/star/tempDir12-2/temp-12_2.fq.gz /scratch/users/lxm416/star/tempDir12-2/temp-12_1.trimmed.fq.gz /scratch/users/lxm416/star/tempDir12-2/temp-12_1.unpaired.fq.gz /scratch/users/lxm416/star/tempDir12-2/temp-12_2.trimmed.fq.gz /scratch/users/lxm416/star/tempDir12-2/temp-12_2.unpaired.fq.gz  ILLUMINACLIP:$adapterFile:2:30:10:8:TRUE LEADING:3 TRAILING:3 SLIDINGWINDOW:4:15 MINLEN:36 

#Input Read Pairs: 1000000 Both Surviving: 945418 (94.54%) Forward Only Surviving: 50749 (5.07%) Reverse Only Surviving: 2981 (0.30%) Dropped: 852 (0.09%)

       STAR --genomeDir $genomeDir \
		 --readFilesIn ${sample}_1.trimmed.fq.gz \
		 ${sample}_2.trimmed.fq.gz \
		 --readFilesCommand zcat \
	  	 --runThreadN $maxProc \
 		 --outSAMtype BAM Unsorted \
		 --outFileNamePrefix ${sample}_star \
		 --outReadsUnmapped Fastx &>/dev/null
STAR --genomeDir dir-genome  --readFilesIn /scratch/users/lxm416/star/tempDir12-2/temp-12_1.trimmed.fq.gz /scratch/users/lxm416/star/tempDir12-2/temp-12_2.trimmed.fq.gz   --readFilesCommand zcat   --runThreadN 2   --outSAMtype BAM Unsorted   --outFileNamePrefix /scratch/users/lxm416/star/tempDir12-2/temp-12-star --outReadsUnmapped  Fastx 

for sample in $(find $dirData -name "*_starAligned.out.bam")
    do
        sampleID=$(echo $sample | sed -r 's/(.?)_starAligned.out.bam$/\1/')
        samtools sort \
                 -n \
                 -@ $maxProc \
                 -o $sampleID.sorted.bam \
                 $sample &>/dev/null
        # delete unsorted bam
        rm $sample
    done
 -@, --threads INT
               Number of additional threads to use [0]
samtools sort -n -@ 4 -o /scratch/users/lxm416/star/tempDir12-2/temp-12.name.sort.bam /scratch/users/lxm416/star/tempDir12-2/temp-12-starAligned.out.bam
samtools index /scratch/users/lxm416/star/tempDir12-2/temp-12.name.sort.bam
rm /scratch/users/lxm416/star/tempDir12-2/temp-12-starAligned.out.bam


module load python/3.7.0
export PYTHONUSERBASE=$HOME/.usr/local/python/3.7.0
echo "$PYTHONUSERBASE"
mkdir -p $PYTHONUSERBASE
export PYTHONUSERBASE=$HOME/.usr/local/python/3.7.0
pip install --user HTSeq

ls $PYTHONUSERBASE/lib/python3.7/site-packages
###HTSeq  HTSeq-0.13.5.dist-info  pysam  pysam-0.16.0.1.dist-info
pip freeze | grep HTSeq

            sampleID=$(echo $sample | sed -r 's/(.?).sorted.bam$/\1/')
            $bin/HTSeq-0.11.2/htseq-count \
                --mode=union \
                --stranded=$stranded \
                --idattr=gene_id \
                --format=bam \
                --quiet \
                $sample \
                $gtfFile \
                > ${sampleID}_counts_gene
            if $isoform
            then
                $bin/HTSeq-0.11.2/htseq-count \
                    --mode=union \
                    --stranded=$stranded \
                    --idattr=transcript_id \
                    --format=bam \
                    --quiet \
                    $sample \
                    $gtfFile \
                    > ${sampleID}_counts_transcript
                python $bin/HTSeq-0.11.2/htseq-count \
                    --mode=union \
                    --stranded=$stranded \
                    --idattr=exon_id \
                    --format=bam \
                    --quiet \
                    $sample \
                    $gtfFile \
                    > ${sampleID}_counts_exon
            fi

python -m HTSeq.scripts.count --mode=union --stranded=no --idattr=exon_id --format=bam  --additional-attr=gene_name  --order=name --type=exon /scratch/users/lxm416/star/tempDir12-2/temp-12.name.sort.bam dir-genome/Homo_sapiens.GRCh38.100.gtf > temp.exon.txt

python -m HTSeq.scripts.count --mode=union --stranded=no --idattr=transcript_id --format=bam  --additional-attr=gene_name --order=name --type=exon /scratch/users/lxm416/star/tempDir12-2/temp-12.name.sort.bam dir-genome/Homo_sapiens.GRCh38.100.gtf > temp.transcript.txt

samtools view -b -o S12.chr1.bam S12-coord.sort.bam 1:123456789-250456789
samtools view 12-star-alnAligned.out.bam | awk 'BEGIN {FS = "\t"; OFS = "\t"} $3 == "Y" && $5 == 255' | grep -w nM:i:0 > temp
cut -f 1 temp | sort | uniq -d | wc -l
##14180

